{% extends "base.html" %}

{% block content %}
<div class="bg-white rounded-lg shadow-sm p-6">
    {% if error %}
    <div class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded relative mb-4" role="alert">
        <strong class="font-bold">é”™è¯¯ï¼</strong>
        <span class="block sm:inline">{{ error }}</span>
    </div>
    {% endif %}

    <!-- Tabs -->
    <div class="border-b border-gray-200 mb-6">
        <div class="flex -mb-px">
            <button onclick="showTab('unpublished')" id="unpublished-tab-button" class="tab-button mr-4 py-2 px-4 border-b-2 border-indigo-500 text-indigo-600 font-medium">
                æœªå‘å¸ƒ
            </button>
            <button onclick="showTab('published')" id="published-tab-button" class="tab-button py-2 px-4 border-b-2 border-transparent text-gray-500 hover:text-gray-700 font-medium">
                å·²å‘å¸ƒ
            </button>
            <button onclick="showTab('scheduled')" id="scheduled-tab-button" class="tab-button py-2 px-4 border-b-2 border-transparent text-gray-500 hover:text-gray-700 font-medium">
                é¢„çº¦å‘å¸ƒ
            </button>
        </div>
    </div>

    <!-- æœªå‘å¸ƒ Tab -->
    <div id="unpublished-tab" class="tab-content">
        <div class="mb-4 flex justify-between items-center">
            <div class="flex items-center space-x-4">
                <label class="relative inline-flex items-center cursor-pointer">
                    <input type="checkbox" id="schedule_publish" class="sr-only peer" onchange="toggleScheduleTime(this)">
                    <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-blue-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"></div>
                    <span class="ml-3 text-sm font-medium text-gray-900">é¢„çº¦å‘å¸ƒ</span>
                </label>
                
                <div id="schedule_time_container" class="hidden">
                    <input type="datetime-local" 
                           id="schedule_time" 
                           class="rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 text-sm"
                           ondblclick="this.readOnly=false"
                           onblur="this.readOnly=true">
                </div>

                <label class="relative inline-flex items-center cursor-pointer">
                    <input type="checkbox" id="add_product_toggle" class="sr-only peer">
                    <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-green-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-green-600"></div>
                    <span class="ml-3 text-sm font-medium text-gray-900">æ·»åŠ å•†å“</span>
                </label>

                <!-- å…¨å±€æ¨¡å¼é€‰æ‹© -->
                <div class="flex items-center space-x-2">
                    <span class="text-sm font-medium text-gray-900">é»˜è®¤æ¨¡å¼:</span>
                    <div class="flex space-x-1">
                        <button id="global-insert-btn" onclick="setGlobalMode('insert')" 
                                class="global-mode-btn px-2 py-1 text-xs rounded bg-gray-200 text-gray-700 hover:bg-gray-300">
                            æ’å…¥
                        </button>
                        <button id="global-random-btn" onclick="setGlobalMode('random')" 
                                class="global-mode-btn px-2 py-1 text-xs rounded bg-green-500 text-white">
                            éšæœº
                        </button>
                        <button id="global-overlay-btn" onclick="setGlobalMode('overlay')" 
                                class="global-mode-btn px-2 py-1 text-xs rounded bg-gray-200 text-gray-700 hover:bg-gray-300">
                            è¦†ç›–
                        </button>
                    </div>
                </div>

                <!-- çŠ¶æ€æŒ‡ç¤ºå™¨ -->
                <div class="flex items-center">
                    <span class="text-xs px-2 py-1 rounded bg-blue-100 text-blue-800" id="template-status">
                        æœªæŒ‡å®šæ¨¡æ¿
                    </span>
                </div>

                <button onclick="fetchEmailMaterials()" class="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700">
                    è·å–é‚®ç®±ç´ æ
                </button>
            </div>
            <div class="flex items-center space-x-3">
                <button id="auto-publish-btn" onclick="toggleAutoPublish()" class="bg-indigo-600 text-white px-4 py-2 rounded hover:bg-indigo-700">
                    è‡ªåŠ¨å‘å¸ƒ
                </button>
                <button onclick="publishSelected()" class="bg-indigo-600 text-white px-4 py-2 rounded hover:bg-indigo-700">
                    ä¸€é”®å‘å¸ƒ
                </button>
            </div>
        </div>
        <div class="overflow-x-auto">
            <table class="min-w-full divide-y divide-gray-200">
                <thead>
                    <tr class="bg-gray-50">
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-10">
                            <div class="flex items-center">
                                <input type="checkbox" id="select-all" onchange="toggleSelectAll(this)">
                                <span class="selection-order ml-2 hidden"></span>
                            </div>
                        </th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer" onclick="sortMaterials('title')">
                            ç´ ææ ‡é¢˜
                            <span id="sort-title" class="ml-1"></span>
                        </th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer" onclick="sortMaterials('region')">
                            åœ°åŒº
                            <span id="sort-region" class="ml-1"></span>
                        </th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer" onclick="sortMaterials('date')">
                            æ—¥æœŸ
                            <span id="sort-date" class="ml-1"></span>
                        </th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">å›¾ç‰‡æ•°é‡</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer" onclick="sortMaterials('accountType')">
                            è´¦å·åç§°
                            <span id="sort-accountType" class="ml-1"></span>
                        </th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">æ“ä½œ</th>
                    </tr>
                </thead>
                <tbody id="unpublished-list" class="bg-white divide-y divide-gray-200">
                    <!-- åŠ¨æ€å†…å®¹å°†ç”± JavaScript å¡«å…… -->
                </tbody>
            </table>
        </div>
    </div>

    <!-- å·²å‘å¸ƒ Tab -->
    <div id="published-tab" class="tab-content hidden">
        <div class="mb-4 flex justify-between items-center">
            <div class="flex space-x-2">
                <button onclick="batchReturnToUnpublished()" class="bg-indigo-600 text-white px-4 py-2 rounded hover:bg-indigo-700">
                    ä¸€é”®è¿”å›
                </button>
                <button onclick="batchClearPublished()" class="bg-red-600 text-white px-4 py-2 rounded hover:bg-red-700">
                    ä¸€é”®æ¸…ç©º
                </button>
            </div>
        </div>
        <div class="overflow-x-auto">
            <table class="min-w-full divide-y divide-gray-200">
                <thead>
                    <tr class="bg-gray-50">
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">å‘å¸ƒæ—¶é—´</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ç´ ææ ‡é¢˜</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">å›¾ç‰‡æ•°é‡</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">å‘å¸ƒè´¦å·</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">å‘å¸ƒçŠ¶æ€</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">æ“ä½œ</th>
                    </tr>
                </thead>
                <tbody id="published-list" class="bg-white divide-y divide-gray-200">
                    <!-- åŠ¨æ€å†…å®¹å°†ç”± JavaScript å¡«å…… -->
                </tbody>
            </table>
        </div>
    </div>

    <!-- é¢„çº¦å‘å¸ƒ Tab -->
    <div id="scheduled-tab" class="tab-content hidden">
        <div class="mb-4 flex justify-between items-center">
            <button onclick="batchCancelSchedule()" class="bg-red-600 text-white px-4 py-2 rounded hover:bg-red-700">
                å–æ¶ˆé¢„çº¦
            </button>
        </div>
        <div class="overflow-x-auto">
            <table class="min-w-full divide-y divide-gray-200">
                <thead>
                    <tr class="bg-gray-50">
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">é¢„çº¦æ—¶é—´</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ç´ ææ ‡é¢˜</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">å›¾ç‰‡æ•°é‡</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">å‘å¸ƒè´¦å·</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">é¢„çº¦çŠ¶æ€</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">æ“ä½œ</th>
                    </tr>
                </thead>
                <tbody id="scheduled-list" class="bg-white divide-y divide-gray-200">
                    <!-- åŠ¨æ€å†…å®¹å°†ç”± JavaScript å¡«å…… -->
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- å¼•å…¥å…±äº«Canvaså›¾ç‰‡ç”Ÿæˆå™¨ -->
<script src="/static/js/canvas-image-generator.js"></script>

<script>
// å…¨å±€å˜é‡ - é‡‡ç”¨å·¥ä½œåŒºç´ æåº“æ¶æ„
let selectedMaterials = new Map();  // ä½¿ç”¨Mapå­˜å‚¨é€‰ä¸­çš„ç´ æIDå’Œé¡ºåº
let currentSort = {
    field: null,
    order: 'asc'
};
let accounts = JSON.parse('{{ accounts|tojson|safe }}');  // ä»æœåŠ¡ç«¯è·å–è´¦å·æ•°æ®
let materials = [];
let regionAccountMapping = {}; // åœ°åŒºè´¦å·æ˜ å°„å…³ç³»

// å…¨å±€é»˜è®¤æ¨¡å¼
let globalDefaultMode = 'random';
let xhsEventSource = null;

// ä»æ ‡é¢˜ä¸­æå–åœ°åŒºå’Œæ—¥æœŸ
function extractRegionAndDate(title) {
    try {
        // åŒ¹é…æ ¼å¼ï¼š2025å¹´XXå¤®å›½ä¼æœ€æ–°æ‹›è˜ä¿¡æ¯ï¼ˆXXæ—¥ï¼‰
        const match = title.match(/(\d+å¹´)(.+?)(å¤®å›½ä¼.*?ï¼ˆ(.+?)ï¼‰)/);
        if (match) {
            const region = match[2].trim(); // æå–åœ°åŒº
            const dateInParentheses = match[4].trim(); // æå–æ‹¬å·ä¸­çš„æ—¥æœŸ
            return { region, date: dateInParentheses };
        }
        
        // å¤‡ç”¨åŒ¹é…æ–¹æ¡ˆ
        const regionMatch = title.match(/å¹´(.+?)å¤®å›½ä¼/);
        const dateMatch = title.match(/ï¼ˆ(.+?)ï¼‰/);
        
        return {
            region: regionMatch ? regionMatch[1] : '-',
            date: dateMatch ? dateMatch[1] : '-'
        };
    } catch (error) {
        console.error('æå–åœ°åŒºå’Œæ—¥æœŸå¤±è´¥:', error);
        return { region: '-', date: '-' };
    }
}

// è§£ææ—¥æœŸå­—ç¬¦ä¸²ç”¨äºæ’åº
function parseDate(dateStr) {
    if (!dateStr || dateStr === '-') return new Date(0);
    
    try {
        // åŒ¹é…æ ¼å¼ï¼š9æœˆ5æ—¥
        const match = dateStr.match(/(\d+)æœˆ(\d+)æ—¥/);
        if (match) {
            const month = parseInt(match[1]);
            const day = parseInt(match[2]);
            // å‡è®¾æ˜¯2025å¹´
            return new Date(2025, month - 1, day);
        }
        return new Date(0);
    } catch (error) {
        return new Date(0);
    }
}

document.addEventListener('DOMContentLoaded', function() {
    console.log('é¡µé¢åŠ è½½å®Œæˆï¼Œå¼€å§‹åˆå§‹åŒ–...');
    showTab('unpublished');
    loadRegionMapping();
    checkTemplateStatus();
    // åŒæ­¥å…¨å±€æ·»åŠ å•†å“å¼€å…³çŠ¶æ€
    syncAddProductToggleFromServer();
    
    // å®šæœŸæ£€æŸ¥æ¨¡æ¿çŠ¶æ€ï¼ˆæ¯30ç§’ï¼‰
    setInterval(checkTemplateStatus, 30000);
    
    // åˆå§‹åŒ–é¢„çº¦å‘å¸ƒæ—¶é—´
    const scheduleTimeInput = document.getElementById('schedule_time');
    if (scheduleTimeInput) {
        const now = new Date();
        const year = now.getFullYear();
        const month = String(now.getMonth() + 1).padStart(2, '0');
        const day = String(now.getDate()).padStart(2, '0');
        const hours = String(now.getHours()).padStart(2, '0');
        const minutes = String(now.getMinutes()).padStart(2, '0');
        scheduleTimeInput.value = `${year}-${month}-${day}T${hours}:${minutes}`;
        scheduleTimeInput.readOnly = true;
    }
    
    // æ¸…ç©ºé€‰æ‹©
    selectedMaterials.clear();

    // åˆå§‹åŒ–è‡ªåŠ¨å‘å¸ƒæŒ‰é’®UI
    updateAutoPublishButtonUI();

    // è‹¥å·²å¼€å¯è‡ªåŠ¨å‘å¸ƒï¼Œåˆ™å»ºç«‹SSEè¿æ¥
    setupAutoPublishEvents();
    
    // ç›‘å¬è·¨é¡µé¢çš„æ¨¡æ¿çŠ¶æ€å˜åŒ–
    window.addEventListener('storage', function(e) {
        if (e.key === 'templateStatus') {
            checkTemplateStatus();
        }
    });
    
    // ç›‘å¬åŒé¡µé¢çš„æ¨¡æ¿çŠ¶æ€å˜åŒ–
    window.addEventListener('templateStatusChanged', function() {
        checkTemplateStatus();
    });
});

// è·å–åœ°åŒºæ˜ å°„å…³ç³»
async function loadRegionMapping() {
    try {
        const response = await fetch('/api/xiaohongshu-settings/config');
        const data = await response.json();
        
        if (data.region_account_mapping) {
            regionAccountMapping = data.region_account_mapping;
            console.log('åŠ è½½åœ°åŒºæ˜ å°„å…³ç³»:', regionAccountMapping);
        }
    } catch (error) {
        console.error('åŠ è½½åœ°åŒºæ˜ å°„å…³ç³»å¤±è´¥:', error);
    }
}

// æ ¹æ®ç´ ææ ‡é¢˜åŒ¹é…è´¦å·ID - ä¿ç•™å°çº¢ä¹¦ç‰¹æœ‰åŠŸèƒ½
function getAccountIdByTitle(title) {
    for (const [regions, accountId] of Object.entries(regionAccountMapping)) {
        const regionList = regions.split(',').map(r => r.trim());
        for (const region of regionList) {
            if (title.includes(region)) {
                console.log(`ç´ æ"${title}"åŒ¹é…åˆ°åœ°åŒº"${region}"ï¼Œè´¦å·ID: ${accountId}`);
                return accountId;
            }
        }
    }
    return null;
}

// æ˜¾ç¤ºæ ‡ç­¾é¡µ - é‡‡ç”¨å·¥ä½œåŒºæ¶æ„
function showTab(tabName) {
    // éšè—æ‰€æœ‰tabå†…å®¹
    document.querySelectorAll('.tab-content').forEach(tab => {
        tab.classList.add('hidden');
    });
    
    // æ˜¾ç¤ºé€‰ä¸­çš„tabå†…å®¹
    document.getElementById(tabName + '-tab').classList.remove('hidden');
    
    // æ›´æ–°tabæŒ‰é’®æ ·å¼
    document.querySelectorAll('.tab-button').forEach(button => {
        button.classList.remove('border-indigo-500', 'text-indigo-600');
        button.classList.add('border-transparent', 'text-gray-500');
    });
    
    // æ›´æ–°ç‚¹å‡»çš„tabæŒ‰é’®æ ·å¼
    document.getElementById(tabName + '-tab-button').classList.remove('border-transparent', 'text-gray-500');
    document.getElementById(tabName + '-tab-button').classList.add('border-indigo-500', 'text-indigo-600');
    
    // é‡ç½®æ’åºçŠ¶æ€ï¼Œé»˜è®¤æŒ‰æ—¥æœŸä»æœ€æ–°åˆ°æœ€æ—©æ’åº
    currentSort = {
        field: 'date',
        order: 'desc'
    };
    updateSortIcons();
    
    // é‡æ–°åŠ è½½æ•°æ®
    loadMaterials(tabName);
}

// åŠ è½½ç´ ææ•°æ® - å®¢æˆ·ç«¯æ¸²æŸ“æ¶æ„
async function loadMaterials(status = 'unpublished') {
    try {
        const response = await fetch(`/api/xiaohongshu-materials?status=${status}`);
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        const data = await response.json();
        materials = data.materials;
        accounts = data.accounts;
        
        // åº”ç”¨é»˜è®¤æ’åºï¼ˆæŒ‰æ—¥æœŸä»æœ€æ–°åˆ°æœ€æ—©ï¼‰
        if (currentSort.field) {
            applyCurrentSort();
        }
        
        const tbody = document.getElementById(status === 'unpublished' ? 'unpublished-list' : 
                                           status === 'published' ? 'published-list' : 'scheduled-list');
        if (!tbody) {
            console.error(`Cannot find tbody element for ${status} materials`);
            return;
        }
        
        renderMaterialsTable(status);
        
        // æ¢å¤é€‰ä¸­çŠ¶æ€
        if (status === 'unpublished') {
            selectedMaterials.forEach((order, id) => {
                const row = document.querySelector(`tr[data-material-id="${id}"]`);
                if (row) {
                    const checkbox = row.querySelector('.material-checkbox');
                    if (checkbox) {
                        checkbox.checked = true;
                        updateSelectionDisplay(checkbox);
                    }
                }
            });
        }
    } catch (error) {
        console.error('Error loading materials:', error);
        showToast('åŠ è½½ç´ æå¤±è´¥: ' + error.message, 'error');
    }
}

// æ¸²æŸ“è¡¨æ ¼æ•°æ®
function renderMaterialsTable(status) {
    const tbody = document.getElementById(status === 'unpublished' ? 'unpublished-list' : 
                                       status === 'published' ? 'published-list' : 'scheduled-list');
    if (!tbody) {
        console.error(`Cannot find tbody element for ${status} materials`);
        return;
    }
    
    tbody.innerHTML = '';
    materials.forEach(material => {
        const tr = document.createElement('tr');
        tr.className = 'hover:bg-gray-50';
        tr.setAttribute('data-material-id', material.id);
        
        if (status === 'unpublished') {
            // å…ˆå°è¯•æ ¹æ®åœ°åŒºæ˜ å°„åŒ¹é…è´¦å·ï¼Œå¦‚æœæ²¡æœ‰æ˜ å°„è´¦å·åˆ™ä½¿ç”¨åŸæœ‰çš„è´¦å·
            let selectedAccountId = material.account_id;
            if (!selectedAccountId) {
                const mappedAccountId = getAccountIdByTitle(material.title);
                if (mappedAccountId) {
                    selectedAccountId = mappedAccountId;
                    // è‡ªåŠ¨æ›´æ–°ç´ æçš„è´¦å·ï¼ˆåå°åŒæ­¥ï¼‰
                    updateAccount(material.id, mappedAccountId, false);
                }
            }
            
            // æå–åœ°åŒºå’Œæ—¥æœŸ
            const {region, date} = extractRegionAndDate(material.title);
            
            tr.innerHTML = `
                <td class="px-6 py-4 whitespace-nowrap">
                    <div class="flex items-center">
                        <input type="checkbox" class="material-checkbox form-checkbox h-4 w-4 text-indigo-600" onchange="updateSelection(this)">
                        <span class="selection-order ml-2 hidden"></span>
                    </div>
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                    <span class="title-text cursor-pointer" 
                          onclick="editTitle(this, '${material.id}')"
                          data-material-id="${material.id}">
                        ${material.title}
                    </span>
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${region}</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${date}</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${material.image_count || 0}</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                    <select class="rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500"
                            onchange="updateAccount('${material.id}', this.value)">
                        <option value="">é€‰æ‹©è´¦å·</option>
                        ${accounts.map(account => `
                            <option value="${account.id}" ${account.id == selectedAccountId ? 'selected' : ''}>
                                ${account.username}
                            </option>
                        `).join('')}
                    </select>
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900 space-x-2">
                    <button onclick="directPublish('${material.id}')"
                            class="text-green-600 hover:text-green-900">ç›´æ¥å‘å¸ƒ</button>
                    <button onclick="deleteMaterial(${material.id})"
                            class="text-red-600 hover:text-red-900">åˆ é™¤</button>
                </td>
            `;
    } else if (status === 'published') {
        const accountName = accounts.find(a => a.id == material.account_id)?.username || '-';
        tr.innerHTML = `
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${material.publish_time ? new Date(material.publish_time).toLocaleString() : '-'}</td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${material.title}</td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${material.image_count || 0}</td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${accountName}</td>
            <td class="px-6 py-4 whitespace-nowrap text-sm ${material.publish_status === 'success' ? 'text-green-600' : 'text-red-600'} font-medium">
                ${material.publish_status === 'success' ? 'å‘å¸ƒæˆåŠŸ' : 'å‘å¸ƒå¤±è´¥'}
            </td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900 space-x-2">
                <button onclick="returnToUnpublished(${material.id})"
                        class="text-green-600 hover:text-green-900">è¿”å›</button>
                <button onclick="deleteMaterial(${material.id})"
                        class="text-red-600 hover:text-red-900">åˆ é™¤</button>
            </td>
        `;
    } else if (status === 'scheduled') {
        const accountName = accounts.find(a => a.id == material.account_id)?.username || '-';
        tr.innerHTML = `
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${material.schedule_time ? (() => {
                const date = new Date(material.schedule_time);
                return date.toLocaleString('zh-CN', {
                    year: 'numeric',
                    month: '2-digit',
                    day: '2-digit',
                    hour: '2-digit',
                    minute: '2-digit',
                    second: '2-digit',
                    hour12: false
                });
            })() : ''}</td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${material.title}</td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${material.image_count || 0}</td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${accountName}</td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">é¢„çº¦ä¸­</td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900 space-x-2">
                <button onclick="cancelSchedule(${material.id})"
                        class="text-red-600 hover:text-red-900">å–æ¶ˆé¢„çº¦</button>
            </td>
        `;
    }
    
        
        tbody.appendChild(tr);
    });
}

// æ‰¹é‡é€‰æ‹©åŠŸèƒ½ - é‡‡ç”¨å·¥ä½œåŒºçš„Mapæ¶æ„
function toggleSelectAll(checkbox) {
    const rows = document.querySelectorAll('tr[data-material-id]');
    console.log('æ‰¾åˆ°çš„è¡Œæ•°:', rows.length);
    
    if (checkbox.checked) {
        // æ¸…ç©ºå½“å‰é€‰æ‹©
        selectedMaterials.clear();
        // æŒ‰é¡ºåºæ·»åŠ æ‰€æœ‰å¤é€‰æ¡†
        let order = 1;
        rows.forEach(row => {
            const materialId = row.getAttribute('data-material-id');
            const cb = row.querySelector('.material-checkbox');
            if (cb && materialId) {
                cb.checked = true;
                selectedMaterials.set(materialId, order++);
                const orderSpan = row.querySelector('.selection-order');
                if (orderSpan) {
                    orderSpan.textContent = selectedMaterials.get(materialId);
                    orderSpan.classList.remove('hidden');
                }
            }
        });
    } else {
        // å–æ¶ˆæ‰€æœ‰é€‰æ‹©
        rows.forEach(row => {
            const cb = row.querySelector('.material-checkbox');
            const orderSpan = row.querySelector('.selection-order');
            if (cb) {
                cb.checked = false;
            }
            if (orderSpan) {
                orderSpan.classList.add('hidden');
            }
        });
        selectedMaterials.clear();
    }
    
    console.log('å…¨é€‰/å–æ¶ˆå…¨é€‰å:', Array.from(selectedMaterials.entries()));
}

function updateSelection(checkbox) {
    const tr = checkbox.closest('tr');
    const materialId = parseInt(tr.getAttribute('data-material-id'));
    const orderSpan = tr.querySelector('.selection-order');
    
    if (checkbox.checked) {
        // æ·»åŠ åˆ°é€‰ä¸­åˆ—è¡¨
        selectedMaterials.set(materialId, selectedMaterials.size + 1);
        orderSpan.textContent = selectedMaterials.get(materialId);
        orderSpan.classList.remove('hidden');
    } else {
        // ä»é€‰ä¸­åˆ—è¡¨ç§»é™¤
        const removedOrder = selectedMaterials.get(materialId);
        selectedMaterials.delete(materialId);
        orderSpan.classList.add('hidden');
        
        // æ›´æ–°å…¶ä»–é€‰ä¸­é¡¹çš„é¡ºåº
        selectedMaterials.forEach((order, id) => {
            if (order > removedOrder) {
                selectedMaterials.set(id, order - 1);
                const otherTr = document.querySelector(`tr[data-material-id="${id}"]`);
                if (otherTr) {
                    const otherOrderSpan = otherTr.querySelector('.selection-order');
                    otherOrderSpan.textContent = order - 1;
                }
            }
        });
    }
    
    console.log('é€‰æ‹©æ›´æ–°å:', Array.from(selectedMaterials.entries()));
}

function updateSelectionDisplay(checkbox) {
    const row = checkbox.closest('tr');
    const materialId = row.getAttribute('data-material-id');
    const orderSpan = checkbox.nextElementSibling;
    
    if (checkbox.checked && selectedMaterials.has(materialId)) {
        orderSpan.textContent = selectedMaterials.get(materialId);
        orderSpan.classList.remove('hidden');
    } else {
        orderSpan.classList.add('hidden');
    }
}

// æ‰¹é‡å‘å¸ƒåŠŸèƒ½
async function publishSelected() {
    // æ£€æŸ¥æ˜¯å¦æœ‰é€‰ä¸­çš„æ–‡ç« 
    if (selectedMaterials.size === 0) {
        alert('è¯·å…ˆé€‰æ‹©è¦å‘å¸ƒçš„ç´ æ');
        return;
    }
    
    if (!confirm('ç¡®å®šè¦ä¸€é”®å‘å¸ƒé€‰ä¸­çš„ç´ æå—ï¼Ÿ')) {
        return;
    }
    
    try {
        // æŒ‰é€‰æ‹©é¡ºåºæ’åºææ–™ID
        const sortedMaterials = Array.from(selectedMaterials.entries())
            .sort((a, b) => a[1] - b[1])
            .map(entry => parseInt(entry[0]))
            .filter(id => !isNaN(id));
            
        // æ£€æŸ¥æ¯ä¸ªé€‰ä¸­çš„ç´ ææ˜¯å¦éƒ½å·²é€‰æ‹©å‘å¸ƒè´¦å·
        const accountErrors = [];
        let allHaveAccounts = true;
        
        for (const materialId of sortedMaterials) {
            const row = document.querySelector(`tr[data-material-id="${materialId}"]`);
            if (!row) continue;
            
            const accountSelect = row.querySelector('select');
            if (!accountSelect || !accountSelect.value) {
                const titleCell = row.querySelector('td:nth-child(2)');
                const title = titleCell ? titleCell.textContent.trim() : `ID: ${materialId}`;
                accountErrors.push(title);
                allHaveAccounts = false;
            }
        }
        
        if (!allHaveAccounts) {
            alert('è¯·ä¸ºä»¥ä¸‹ç´ æé€‰æ‹©å‘å¸ƒè´¦å·ï¼š\n' + accountErrors.join('\n'));
            return;
        }
        
        // è·å–é¢„çº¦å‘å¸ƒçŠ¶æ€å’Œæ—¶é—´
        const schedulePublish = document.getElementById('schedule_publish').checked;
        let scheduleTime = null;
        if (schedulePublish) {
            const scheduleTimeInput = document.getElementById('schedule_time').value;
            if (!scheduleTimeInput) {
                alert('è¯·é€‰æ‹©é¢„çº¦å‘å¸ƒæ—¶é—´');
                return;
            }
            // å°†æœ¬åœ°æ—¶é—´è½¬æ¢ä¸º ISO æ ¼å¼
            scheduleTime = new Date(scheduleTimeInput).toISOString();
        }
        
        const addProduct = document.getElementById('add_product_toggle').checked;
        
        console.log('å‘å¸ƒå‚æ•°:', {
            schedulePublish,
            scheduleTime,
            addProduct
        });
        
        // åº”ç”¨å‰ç«¯å›¾ç‰‡æ¨¡ç‰ˆç”Ÿæˆ
        await processImageTemplatesForMaterials(sortedMaterials);
        
        const response = await fetch('/api/xiaohongshu-materials/publish-batch', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ 
                material_ids: sortedMaterials,
                schedule_publish: schedulePublish,
                schedule_time: scheduleTime,
                add_product: addProduct,
                default_mode: globalDefaultMode
            })
        });
        
        const data = await response.json();
        if (response.ok) {
            // æäº¤æˆåŠŸï¼Œä¸å†å¼¹çª—æˆ–å¼ºåˆ¶åˆ·æ–°ï¼›ç­‰å¾… SSE é€æ¡åˆ·æ–°
        } else {
            throw new Error(data.detail || 'å‘å¸ƒå¤±è´¥');
        }
    } catch (error) {
        console.error('Error:', error);
        showToast('å‘å¸ƒè¿‡ç¨‹å‡ºé”™ï¼š' + error.message, 'error');
    }
}

/**
 * ä¸ºç´ ææ‰¹é‡å¤„ç†å›¾ç‰‡æ¨¡ç‰ˆç”Ÿæˆ
 * @param {Array} materialIds - ç´ æIDæ•°ç»„
 */
async function processImageTemplatesForMaterials(materialIds) {
    console.log('ğŸ¯ å¼€å§‹ä¸ºç´ æç”Ÿæˆå›¾ç‰‡æ¨¡ç‰ˆ:', materialIds);
    console.log('ğŸ“‹ å¤„ç†ç´ ææ•°é‡:', materialIds.length);
    
    for (const materialId of materialIds) {
        try {
            console.log(`ğŸ”§ å¤„ç†ç´ æ ${materialId} çš„å›¾ç‰‡æ¨¡ç‰ˆ...`);
            
            // 1. è·å–ç´ æçš„å›¾ç‰‡æ¨¡ç‰ˆé…ç½®
            console.log(`ğŸ“¡ å‘é€è¯·æ±‚è·å–ç´ æ ${materialId} çš„æ¨¡ç‰ˆé…ç½®...`);
            const configResponse = await fetch(`/api/template-materials/generate-template-image-for-material?material_id=${materialId}&default_mode=${encodeURIComponent(globalDefaultMode)}`, {
                method: 'POST'
            });
            
            console.log(`ğŸ“„ ç´ æ ${materialId} é…ç½®è¯·æ±‚å“åº”çŠ¶æ€:`, configResponse.status, configResponse.statusText);
            
            if (!configResponse.ok) {
                console.error(`âŒ ç´ æ ${materialId} è·å–æ¨¡ç‰ˆé…ç½®å¤±è´¥:`, configResponse.status);
                const errorText = await configResponse.text();
                console.error(`é”™è¯¯å“åº”å†…å®¹:`, errorText);
                throw new Error(`ç´ æ ${materialId} è·å–æ¨¡ç‰ˆé…ç½®å¤±è´¥: HTTP ${configResponse.status}`);
            }
            
            const configData = await configResponse.json();
            console.log(`ğŸ“ ç´ æ ${materialId} é…ç½®å“åº”æ•°æ®:`, configData);
            
            if (!configData.success) {
                console.error(`âŒ ç´ æ ${materialId} æ¨¡ç‰ˆé…ç½®è·å–å¤±è´¥:`, configData.message);
                throw new Error(`ç´ æ ${materialId} æ¨¡ç‰ˆé…ç½®è·å–å¤±è´¥: ${configData.message}`);
            }
            
            console.log(`âœ… ç´ æ ${materialId} çš„æ¨¡ç‰ˆé…ç½®è·å–æˆåŠŸ:`, configData);
            
            // 2. ç¡®ä¿Canvasç”Ÿæˆå™¨å¯ç”¨å¹¶ç”Ÿæˆå›¾ç‰‡
            try {
                console.log(`ğŸ”§ ç¡®ä¿Canvasç”Ÿæˆå™¨å°±ç»ª...`);
                const generator = await ensureCanvasGeneratorReady();
                
                // åˆå§‹åŒ–Canvas (ä½¿ç”¨ç”Ÿæˆç”¨çš„å°ºå¯¸)
                const canvas = generator.initialize('temp-canvas-for-generation', 750, 1000);
                
                // ç”Ÿæˆå›¾ç‰‡
                const imageData = await generator.generateImage(
                    configData.template_config,
                    configData.text_lines,
                    configData.mode
                );
                
                console.log(`âœ… ç´ æ ${materialId} å›¾ç‰‡ç”ŸæˆæˆåŠŸ`);
                
                // 3. ä¿å­˜ç”Ÿæˆçš„å›¾ç‰‡
                let filename;
                let outputPath;
                
                if (configData.mode === 'overlay') {
                    // è¦†ç›–æ¨¡å¼ï¼ˆæ”¹ä¸ºéç ´åå¼ï¼‰ï¼šç”Ÿæˆæ–°é¦–å›¾
                    filename = '00_template_generated.png';
                    outputPath = configData.output_path;
                    console.log(`ğŸ¯ è¦†ç›–æ¨¡å¼: æ–°é¦–å›¾ ${filename}, ä¿å­˜è·¯å¾„ ${outputPath}`);
                } else {
                    // æ’å…¥æ¨¡å¼ï¼šç”Ÿæˆæ–°çš„ç¬¬ä¸€å¼ å›¾ç‰‡
                    filename = '00_template_generated.png';
                    outputPath = configData.output_path;
                }
                
                const saveResponse = await fetch('/api/template-materials/save-generated-image', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        image_data: imageData,
                        output_path: outputPath,
                        filename: filename
                    })
                });
                
                if (saveResponse.ok) {
                    const saveData = await saveResponse.json();
                    console.log(`âœ… ç´ æ ${materialId} å›¾ç‰‡ä¿å­˜æˆåŠŸ:`, saveData.filename);
                } else {
                    console.error(`âŒ ç´ æ ${materialId} å›¾ç‰‡ä¿å­˜å¤±è´¥:`, saveResponse.status);
                    const errorText = await saveResponse.text();
                    console.error(`ä¿å­˜é”™è¯¯è¯¦æƒ…:`, errorText);
                    throw new Error(`ç´ æ ${materialId} å›¾ç‰‡ä¿å­˜å¤±è´¥: HTTP ${saveResponse.status}`);
                }
                
            } catch (generateError) {
                console.error(`âŒ ç´ æ ${materialId} Canvaså¤„ç†å¤±è´¥:`, generateError);
                throw new Error(`ç´ æ ${materialId} æ¨¡æ¿å¤„ç†å¤±è´¥: ${generateError.message}`);
            }
            
        } catch (error) {
            console.error(`âŒ å¤„ç†ç´ æ ${materialId} æ—¶å‡ºé”™:`, error);
            throw error; // ä¸¥æ ¼æŠ›å‡ºé”™è¯¯ï¼Œä¸å…è®¸ç»§ç»­
        }
    }
    
    console.log('å›¾ç‰‡æ¨¡ç‰ˆç”Ÿæˆå¤„ç†å®Œæˆ');
}

// å·¥å…·å‡½æ•°
function toggleScheduleTime(checkbox) {
    const container = document.getElementById('schedule_time_container');
    if (checkbox.checked) {
        container.classList.remove('hidden');
    } else {
        container.classList.add('hidden');
    }
}

function sortMaterials(field) {
    // åˆ‡æ¢æ’åºæ–¹å‘
    if (currentSort.field === field) {
        currentSort.order = currentSort.order === 'asc' ? 'desc' : 'asc';
    } else {
        currentSort.field = field;
        currentSort.order = 'asc';
    }
    
    // å¯¹materialsæ•°ç»„è¿›è¡Œæ’åº
    materials.sort((a, b) => {
        let valueA, valueB;
        
        switch (field) {
            case 'title':
                valueA = a.title.toLowerCase();
                valueB = b.title.toLowerCase();
                break;
            case 'region':
                valueA = extractRegionAndDate(a.title).region;
                valueB = extractRegionAndDate(b.title).region;
                break;
            case 'date':
                // æ—¥æœŸæŒ‰ä»æœ€æ–°åˆ°æœ€æ—©æ’åºï¼Œæ‰€ä»¥é»˜è®¤é™åº
                const dateA = parseDate(extractRegionAndDate(a.title).date);
                const dateB = parseDate(extractRegionAndDate(b.title).date);
                if (currentSort.order === 'asc') {
                    return dateA - dateB;
                } else {
                    return dateB - dateA;
                }
            case 'accountType':
                const accountA = accounts.find(acc => acc.id == a.account_id);
                const accountB = accounts.find(acc => acc.id == b.account_id);
                valueA = accountA ? accountA.username.toLowerCase() : '';
                valueB = accountB ? accountB.username.toLowerCase() : '';
                break;
            default:
                return 0;
        }
        
        // å¯¹äºéæ—¥æœŸå­—æ®µçš„æ’åº
        if (field !== 'date') {
            if (valueA < valueB) {
                return currentSort.order === 'asc' ? -1 : 1;
            }
            if (valueA > valueB) {
                return currentSort.order === 'asc' ? 1 : -1;
            }
            return 0;
        }
        
        return 0;
    });
    
    // æ›´æ–°æ’åºå›¾æ ‡
    updateSortIcons();
    
    // é‡æ–°æ¸²æŸ“è¡¨æ ¼
    const currentTab = document.querySelector('.tab-button.border-indigo-500').id.replace('-tab-button', '');
    renderMaterialsTable(currentTab);
}

// åº”ç”¨å½“å‰æ’åº
function applyCurrentSort() {
    if (!currentSort.field || !materials.length) return;
    
    materials.sort((a, b) => {
        let valueA, valueB;
        
        switch (currentSort.field) {
            case 'title':
                valueA = a.title.toLowerCase();
                valueB = b.title.toLowerCase();
                break;
            case 'region':
                valueA = extractRegionAndDate(a.title).region;
                valueB = extractRegionAndDate(b.title).region;
                break;
            case 'date':
                const dateA = parseDate(extractRegionAndDate(a.title).date);
                const dateB = parseDate(extractRegionAndDate(b.title).date);
                if (currentSort.order === 'asc') {
                    return dateA - dateB;
                } else {
                    return dateB - dateA;
                }
            case 'accountType':
                const accountA = accounts.find(acc => acc.id == a.account_id);
                const accountB = accounts.find(acc => acc.id == b.account_id);
                valueA = accountA ? accountA.username.toLowerCase() : '';
                valueB = accountB ? accountB.username.toLowerCase() : '';
                break;
            default:
                return 0;
        }
        
        // å¯¹äºéæ—¥æœŸå­—æ®µçš„æ’åº
        if (currentSort.field !== 'date') {
            if (valueA < valueB) {
                return currentSort.order === 'asc' ? -1 : 1;
            }
            if (valueA > valueB) {
                return currentSort.order === 'asc' ? 1 : -1;
            }
            return 0;
        }
        
        return 0;
    });
}

function updateSortIcons() {
    // æ¸…é™¤æ‰€æœ‰æ’åºå›¾æ ‡
    document.querySelectorAll('[id^=sort-]').forEach(span => {
        span.textContent = '';
    });
    
    // æ›´æ–°å½“å‰æ’åºå›¾æ ‡
    if (currentSort.field) {
        const iconSpan = document.getElementById(`sort-${currentSort.field}`);
        if (iconSpan) {
            iconSpan.textContent = currentSort.order === 'asc' ? 'â†‘' : 'â†“';
        }
    }
}

// APIè°ƒç”¨å‡½æ•°
async function updateAccount(materialId, accountId, showAlert = true) {
    try {
        const response = await fetch(`/api/xiaohongshu-materials/${materialId}/account`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ account_id: parseInt(accountId) })
        });
        
        const data = await response.json();
        if (!data.success && showAlert) {
            alert('æ›´æ–°è´¦å·å¤±è´¥: ' + data.message);
        } else if (data.success && !showAlert) {
            console.log(`ç´ æ ${materialId} è‡ªåŠ¨åŒ¹é…è´¦å· ${accountId} æˆåŠŸ`);
        }
    } catch (error) {
        console.error('Error:', error);
        if (showAlert) {
            alert('æ›´æ–°è´¦å·å¤±è´¥: ' + error.message);
        }
    }
}

async function editTitle(element, materialId) {
    const titleText = element.textContent.trim();
    const input = document.createElement('input');
    input.type = 'text';
    input.value = titleText;
    input.className = 'w-full px-2 py-1 border rounded';
    
    input.onblur = async () => {
        const newTitle = input.value.trim();
        if (newTitle !== titleText) {
            try {
                const response = await fetch(`/api/xiaohongshu-materials/${materialId}/title`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ title: newTitle })
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                showToast('æ ‡é¢˜æ›´æ–°æˆåŠŸ', 'success');
                await loadMaterials(); // åˆ·æ–°åˆ—è¡¨
            } catch (error) {
                console.error('æ›´æ–°æ ‡é¢˜å¤±è´¥:', error);
                showToast('æ›´æ–°æ ‡é¢˜å¤±è´¥ï¼Œè¯·é‡è¯•', 'error');
                element.textContent = titleText; // æ¢å¤åŸæ ‡é¢˜
            }
        } else {
            element.textContent = titleText;
        }
    };
    
    input.onkeydown = (e) => {
        if (e.key === 'Enter') {
            input.blur();
        } else if (e.key === 'Escape') {
            element.textContent = titleText;
        }
    };
    
    element.textContent = '';
    element.appendChild(input);
    input.focus();
    input.select();
}

async function directPublish(materialId) {
    try {
        const addProduct = document.getElementById('add_product_toggle').checked;
        
        // æ˜¾ç¤ºå‘å¸ƒè¿›åº¦
        showToast('æ­£åœ¨åº”ç”¨æ¨¡æ¿å¹¶å‘å¸ƒ...', 'info');
        
        // åº”ç”¨å‰ç«¯å›¾ç‰‡æ¨¡ç‰ˆç”Ÿæˆ
        await processImageTemplatesForMaterials([materialId]);
        
        const response = await fetch(`/api/xiaohongshu-materials/${materialId}/direct-publish`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                add_product: addProduct,
                default_mode: globalDefaultMode
            })
        });
        
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        const result = await response.json();
        
        if (!result.success) {
            showToast('å‘å¸ƒå¤±è´¥: ' + (result.message || 'æœªçŸ¥é”™è¯¯'), 'error');
        }
        // æˆåŠŸæ—¶ä¸å†å¼¹çª—ï¼Œä¸å†ç«‹å³åˆ·æ–°ï¼›SSE ä¼šæ¨åŠ¨åˆ·æ–°
    } catch (error) {
        console.error('å‘å¸ƒå¤±è´¥:', error);
        showToast('å‘å¸ƒå¤±è´¥ï¼Œè¯·é‡è¯•: ' + error.message, 'error');
    }
}

async function deleteMaterial(materialId) {
    if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªç´ æå—ï¼Ÿ')) {
        return;
    }
    
    try {
        const response = await fetch(`/api/xiaohongshu-materials/${materialId}`, {
            method: 'DELETE'
        });
        
        const data = await response.json();
        if (data.success) {
            window.location.reload();
        } else {
            alert('åˆ é™¤å¤±è´¥ï¼š' + data.message);
        }
    } catch (error) {
        console.error('Error:', error);
        alert('æ“ä½œå¤±è´¥ï¼š' + error.message);
    }
}

async function returnToUnpublished(materialId) {
    if (!confirm('ç¡®å®šè¦å°†æ­¤ç´ æè¿”å›åˆ°æœªå‘å¸ƒçŠ¶æ€å—ï¼Ÿ')) {
        return;
    }
    
    try {
        const response = await fetch(`/api/xiaohongshu-materials/${materialId}/status`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ status: 'unpublished' })
        });
        
        if (!response.ok) {
            const errorData = await response.json();
            throw new Error(errorData.detail || 'è¿”å›å¤±è´¥');
        }
        
        const data = await response.json();
        if (data.success) {
            window.location.reload();
        } else {
            alert('è¿”å›å¤±è´¥ï¼š' + data.message);
        }
    } catch (error) {
        console.error('Error:', error);
        alert('æ“ä½œå¤±è´¥ï¼š' + error.message);
    }
}

async function cancelSchedule(materialId) {
    if (!confirm('ç¡®å®šè¦å–æ¶ˆè¿™ä¸ªé¢„çº¦å‘å¸ƒä»»åŠ¡å—ï¼Ÿ')) {
        return;
    }
    
    try {
        const response = await fetch(`/api/xiaohongshu-materials/${materialId}/status`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ status: 'unpublished' })
        });
        
        const data = await response.json();
        if (data.success) {
            alert(data.message);
            window.location.reload();
        } else {
            alert('å–æ¶ˆå¤±è´¥ï¼š' + data.message);
        }
    } catch (error) {
        console.error('Error:', error);
        alert('æ“ä½œå¤±è´¥ï¼š' + error.message);
    }
}

async function batchReturnToUnpublished() {
    if (!confirm('ç¡®å®šè¦å°†æ‰€æœ‰å·²å‘å¸ƒçš„ç´ æè¿”å›åˆ°æœªå‘å¸ƒçŠ¶æ€å—ï¼Ÿ')) {
        return;
    }
    
    try {
        const response = await fetch('/api/xiaohongshu-materials/batch-return', {
            method: 'POST'
        });
        
        const data = await response.json();
        if (data.success) {
            window.location.reload();
        } else {
            alert('æ‰¹é‡è¿”å›å¤±è´¥ï¼š' + data.message);
        }
    } catch (error) {
        console.error('Error:', error);
        alert('æ“ä½œå¤±è´¥ï¼š' + error.message);
    }
}

async function batchClearPublished() {
    if (!confirm('ç¡®å®šè¦æ¸…ç©ºå·²å‘å¸ƒé¡µé¢çš„æ‰€æœ‰æ˜¾ç¤ºå†…å®¹å—ï¼Ÿ\n\næ³¨æ„ï¼šè¿™ä¸ä¼šçœŸæ­£åˆ é™¤æ•°æ®ï¼Œé‡æ–°æ‰«æç´ æåº“æ—¶å¯ä»¥æ¢å¤è¿™äº›è®°å½•ã€‚')) {
        return;
    }
    
    try {
        const response = await fetch('/api/xiaohongshu-materials/batch-clear', {
            method: 'POST'
        });
        
        const data = await response.json();
        if (data.success) {
            alert(`æˆåŠŸæ¸…ç©ºäº† ${data.cleared_count} æ¡è®°å½•`);
            window.location.reload();
        } else {
            alert('æ¸…ç©ºå¤±è´¥ï¼š' + data.message);
        }
    } catch (error) {
        console.error('Error:', error);
        alert('æ“ä½œå¤±è´¥ï¼š' + error.message);
    }
}

async function batchCancelSchedule() {
    if (!confirm('ç¡®å®šè¦å–æ¶ˆæ‰€æœ‰é¢„çº¦å‘å¸ƒä»»åŠ¡å—ï¼Ÿ')) {
        return;
    }
    
    try {
        const response = await fetch('/api/xiaohongshu-materials/batch-cancel-scheduled', {
            method: 'POST'
        });
        
        const data = await response.json();
        if (data.success) {
            alert(data.message);
            window.location.reload();
        } else {
            alert('å–æ¶ˆå¤±è´¥ï¼š' + data.message);
        }
    } catch (error) {
        console.error('Error:', error);
        alert('æ“ä½œå¤±è´¥ï¼š' + error.message);
    }
}

async function fetchEmailMaterials() {
    const button = event.target;
    const originalText = button.textContent;
    button.textContent = 'æ­£åœ¨è·å–...';
    button.disabled = true;
    
    try {
        const response = await fetch('/api/xiaohongshu-materials/fetch-email-materials', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            }
        });
        
        if (!response.ok) {
            const errorData = await response.json();
            throw new Error(errorData.detail || `HTTP ${response.status}`);
        }
        
        const result = await response.json();
        
        if (result.success) {
            alert(result.message);
            location.reload(); // é‡æ–°åŠ è½½é¡µé¢æ˜¾ç¤ºæ–°ç´ æ
        } else {
            alert('è·å–é‚®ç®±ç´ æå¤±è´¥: ' + (result.message || 'æœªçŸ¥é”™è¯¯'));
        }
    } catch (error) {
        console.error('Error:', error);
        alert('è·å–é‚®ç®±ç´ æå¤±è´¥: ' + error.message);
    } finally {
        button.textContent = originalText;
        button.disabled = false;
    }
}

// è®¾ç½®å…¨å±€æ¨¡å¼
async function setGlobalMode(mode) {
    globalDefaultMode = mode;
    
    // æ›´æ–°æŒ‰é’®çŠ¶æ€
    document.querySelectorAll('.global-mode-btn').forEach(btn => {
        btn.className = 'global-mode-btn px-2 py-1 text-xs rounded bg-gray-200 text-gray-700 hover:bg-gray-300';
    });
    
    const activeBtn = document.getElementById(`global-${mode}-btn`);
    if (activeBtn) {
        if (mode === 'insert') {
            activeBtn.className = 'global-mode-btn px-2 py-1 text-xs rounded bg-blue-500 text-white';
        } else if (mode === 'random') {
            activeBtn.className = 'global-mode-btn px-2 py-1 text-xs rounded bg-green-500 text-white';
        } else if (mode === 'overlay') {
            activeBtn.className = 'global-mode-btn px-2 py-1 text-xs rounded bg-orange-500 text-white';
        }
    }
    
    console.log(`å…¨å±€é»˜è®¤æ¨¡å¼è®¾ç½®ä¸º: ${mode}`);
    // æŒä¹…åŒ–åˆ°åç«¯ï¼Œä¾›è‡ªåŠ¨å‘å¸ƒè¯»å–
    try {
        await fetch('/api/xiaohongshu-settings/default-mode', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ mode })
        });
    } catch (e) {}
}

// æ£€æŸ¥æ¨¡æ¿æŒ‡å®šçŠ¶æ€
async function checkTemplateStatus() {
    try {
        const response = await fetch('/api/template-materials/get-template-status');
        const result = await response.json();
        
        const statusElement = document.getElementById('template-status');
        if (statusElement) {
            if (result.success && result.has_template) {
                statusElement.textContent = 'å·²æŒ‡å®šæ¨¡æ¿';
                statusElement.className = 'text-xs px-2 py-1 rounded bg-red-100 text-red-800';
            } else {
                statusElement.textContent = 'æœªæŒ‡å®šæ¨¡æ¿';
                statusElement.className = 'text-xs px-2 py-1 rounded bg-blue-100 text-blue-800';
            }
        }
    } catch (error) {
        console.error('æ£€æŸ¥æ¨¡æ¿çŠ¶æ€å¤±è´¥:', error);
        const statusElement = document.getElementById('template-status');
        if (statusElement) {
            statusElement.textContent = 'æœªæŒ‡å®šæ¨¡æ¿';
            statusElement.className = 'text-xs px-2 py-1 rounded bg-blue-100 text-blue-800';
        }
    }
}

// è‡ªåŠ¨å‘å¸ƒå¼€å…³ï¼ˆä»…å‰ç«¯æ ·å¼ + æœ¬åœ°æŒä¹…åŒ–ï¼‰
function isAutoPublishEnabled() {
    try {
        return localStorage.getItem('xhs_auto_publish_enabled') === '1';
    } catch (_) {
        return false;
    }
}

function setAutoPublishEnabled(enabled) {
    try {
        localStorage.setItem('xhs_auto_publish_enabled', enabled ? '1' : '0');
    } catch (_) {}
}

function updateAutoPublishButtonUI() {
    const btn = document.getElementById('auto-publish-btn');
    if (!btn) return;
    const enabled = isAutoPublishEnabled();
    if (enabled) {
        btn.textContent = 'è‡ªåŠ¨å‘å¸ƒä¸­';
        btn.className = 'bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700';
    } else {
        btn.textContent = 'è‡ªåŠ¨å‘å¸ƒ';
        btn.className = 'bg-indigo-600 text-white px-4 py-2 rounded hover:bg-indigo-700';
    }
}

function toggleAutoPublish() {
    const enabled = isAutoPublishEnabled();
    const newState = !enabled;
    // åç«¯åˆ‡æ¢
    fetch('/api/xiaohongshu-settings/auto-publish/toggle', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ enabled: newState })
    })
    .then(res => res.json())
    .then(data => {
        if (data && data.success) {
            setAutoPublishEnabled(newState);
            updateAutoPublishButtonUI();
            showToast(newState ? 'è‡ªåŠ¨å‘å¸ƒå·²å¼€å¯' : 'è‡ªåŠ¨å‘å¸ƒå·²å…³é—­', newState ? 'success' : 'info');
            setupAutoPublishEvents();
        } else {
            showToast('è‡ªåŠ¨å‘å¸ƒåˆ‡æ¢å¤±è´¥: ' + (data.message || 'æœªçŸ¥é”™è¯¯'), 'error');
        }
    })
    .catch(err => {
        console.error(err);
        showToast('è‡ªåŠ¨å‘å¸ƒåˆ‡æ¢å¤±è´¥: ' + err.message, 'error');
    });
}

function setupAutoPublishEvents() {
    const enabled = isAutoPublishEnabled();
    if (enabled) {
        try {
            if (xhsEventSource) {
                xhsEventSource.close();
                xhsEventSource = null;
            }
            if (!!window.EventSource) {
                xhsEventSource = new EventSource('/api/xiaohongshu-settings/auto-events');
                xhsEventSource.onmessage = function (e) {
                    try {
                        const msg = JSON.parse(e.data);
                        if (msg && msg.type === 'xhs_auto_fetch') {
                            showToast(`æ”¶åˆ°è‡ªåŠ¨ç´ ææ›´æ–°ï¼šæ–°å¢ ${msg.added || 0}ï¼Œæ›´æ–° ${msg.updated || 0}`, 'success');
                            // æ ¹æ®å½“å‰tabåˆ·æ–°åˆ—è¡¨
                            let status = 'unpublished';
                            const activeBtn = document.querySelector('.tab-button.border-indigo-500');
                            if (activeBtn) {
                                if (activeBtn.id === 'published-tab-button') status = 'published';
                                if (activeBtn.id === 'scheduled-tab-button') status = 'scheduled';
                            }
                            loadMaterials(status);
                        }
                    } catch (err) {
                        console.error('SSE parse error:', err);
                    }
                };
                xhsEventSource.onerror = function () {
                    // ç½‘ç»œæ–­å¼€æ—¶ç¨åé‡è¿
                    setTimeout(() => setupAutoPublishEvents(), 5000);
                };
            }
        } catch (err) {
            console.error('SSE setup error:', err);
        }
    } else {
        if (xhsEventSource) {
            xhsEventSource.close();
            xhsEventSource = null;
        }
    }
}

// æ˜¾ç¤ºæç¤ºä¿¡æ¯
function showToast(message, type = 'info') {
    const toast = document.createElement('div');
    toast.className = `fixed bottom-4 right-4 px-6 py-3 rounded shadow-lg ${
        type === 'error' ? 'bg-red-500' :
        type === 'success' ? 'bg-green-500' :
        type === 'warning' ? 'bg-yellow-500' :
        'bg-blue-500'
    } text-white`;
    toast.textContent = message;
    
    document.body.appendChild(toast);
    setTimeout(() => {
        toast.remove();
    }, 3000);
}
// å°†é¡µé¢ä¸Šçš„â€œæ·»åŠ å•†å“â€å¼€å…³ä¸åç«¯å…¨å±€çŠ¶æ€ä¿æŒä¸€è‡´
function syncAddProductToggleFromServer() {
    fetch('/api/xiaohongshu-settings/config')
        .then(res => res.json())
        .then(data => {
            if (data && typeof data.add_product_enabled !== 'undefined') {
                const toggle = document.getElementById('add_product_toggle');
                if (toggle) toggle.checked = !!data.add_product_enabled;
            }
        })
        .catch(() => {});
}

// ç›‘å¬â€œæ·»åŠ å•†å“â€å¼€å…³å˜åŒ–å¹¶æŒä¹…åŒ–åˆ°åç«¯
document.addEventListener('change', function(e) {
    if (e.target && e.target.id === 'add_product_toggle') {
        const enabled = e.target.checked;
        fetch('/api/xiaohongshu-settings/add-product/toggle', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ enabled })
        }).then(res => res.json()).then(data => {
            if (!(data && data.success)) {
                showToast('ä¿å­˜æ·»åŠ å•†å“çŠ¶æ€å¤±è´¥', 'error');
            }
        }).catch(() => showToast('ä¿å­˜æ·»åŠ å•†å“çŠ¶æ€å¤±è´¥', 'error'));
    }
});

// é¡µé¢åŠ è½½æ—¶åŒæ­¥çŠ¶æ€
document.addEventListener('DOMContentLoaded', syncAddProductToggleFromServer);

</script>

<!-- å¼•å…¥Canvaså›¾ç‰‡ç”Ÿæˆå™¨ -->
<script src="{{ url_for('static', path='js/canvas-image-generator.js') }}"></script>
<script>
// ç¡®ä¿Canvaså›¾ç‰‡ç”Ÿæˆå™¨å¯ç”¨çš„å‡½æ•°
function ensureCanvasGeneratorReady() {
    return new Promise((resolve, reject) => {
        if (window.canvasImageGenerator) {
            console.log('âœ… Canvaså›¾ç‰‡ç”Ÿæˆå™¨å·²å°±ç»ª');
            resolve(window.canvasImageGenerator);
            return;
        }
        
        // å¦‚æœè¿˜æ²¡åˆå§‹åŒ–ï¼Œå°è¯•åˆå§‹åŒ–
        if (typeof CanvasImageGenerator !== 'undefined') {
            console.log('ğŸ¯ åˆå§‹åŒ–Canvaså›¾ç‰‡ç”Ÿæˆå™¨...');
            window.canvasImageGenerator = new CanvasImageGenerator();
            console.log('âœ… Canvaså›¾ç‰‡ç”Ÿæˆå™¨åˆå§‹åŒ–å®Œæˆ');
            resolve(window.canvasImageGenerator);
        } else {
            console.error('âŒ CanvasImageGenerator ç±»æœªåŠ è½½');
            reject(new Error('CanvasImageGenerator ç±»æœªåŠ è½½'));
        }
    });
}

// DOMåŠ è½½å®Œæˆæ—¶åˆå§‹åŒ–
document.addEventListener('DOMContentLoaded', function() {
    console.log('ğŸ¯ é¡µé¢åŠ è½½å®Œæˆï¼Œåˆå§‹åŒ–Canvaså›¾ç‰‡ç”Ÿæˆå™¨...');
    ensureCanvasGeneratorReady().catch(error => {
        console.error('Canvaså›¾ç‰‡ç”Ÿæˆå™¨åˆå§‹åŒ–å¤±è´¥:', error);
    });
});
</script>
{% endblock %}
