from fastapi import APIRouter, Depends, HTTPException, UploadFile, File
from sqlalchemy.orm import Session
from typing import Optional, List
from datetime import datetime
from models.database import get_db, ImageTemplate, ContentTemplate, TemplateState
from pydantic import BaseModel
import json
import random
import os
from pathlib import Path
import shutil
import re
import base64
import uuid

router = APIRouter(prefix="/api/template-materials", tags=["template-materials"])

# Request models
class ImageTemplateCreate(BaseModel):
    name: str
    template_type: str  # 'insert' or 'overlay'
    text_style: str
    text_color: str = '#2c3e50'
    background_style: str
    font_size: int = 40
    line_height: str = '1.2'
    mask_opacity: str = '0'
    text_lines: int = 3
    custom_background_path: Optional[str] = None

class ContentTemplateCreate(BaseModel):
    name: str
    description_templates: Optional[List[str]] = []
    use_random_description: bool = True
    no_description: bool = False
    topic_templates: Optional[List[str]] = []
    topic_count: int = 7

class TemplateStateUpdate(BaseModel):
    template_type: str  # 'image' or 'content'
    template_id: Optional[int] = None
    mode: str = 'random'
    enabled: bool = True

@router.get("/image-templates")
async def get_image_templates(db: Session = Depends(get_db)):
    """è·å–æ‰€æœ‰å›¾ç‰‡æ¨¡æ¿"""
    templates = db.query(ImageTemplate).order_by(ImageTemplate.created_at.desc()).all()
    return [{
        "id": t.id, 
        "name": t.name, 
        "template_type": t.template_type,
        "text_style": t.text_style,
        "text_color": t.text_color,
        "background_style": t.background_style,
        "font_size": t.font_size,
        "line_height": t.line_height,
        "mask_opacity": t.mask_opacity,
        "text_lines": t.text_lines,
        "custom_background_path": t.custom_background_path,
        "created_at": t.created_at.isoformat()
    } for t in templates]

@router.get("/content-templates")  
async def get_content_templates(db: Session = Depends(get_db)):
    """è·å–æ‰€æœ‰å†…å®¹æ¨¡æ¿"""
    templates = db.query(ContentTemplate).order_by(ContentTemplate.created_at.desc()).all()
    result = []
    for t in templates:
        description_templates = []
        topic_templates = []
        
        if t.description_templates:
            try:
                description_templates = json.loads(t.description_templates)
            except:
                pass
                
        if t.topic_templates:
            try:
                topic_templates = json.loads(t.topic_templates)
            except:
                pass
        
        result.append({
            "id": t.id,
            "name": t.name,
            "description_templates": description_templates,
            "use_random_description": t.use_random_description,
            "no_description": t.no_description,
            "topic_templates": topic_templates,
            "topic_count": t.topic_count,
            "created_at": t.created_at.isoformat()
        })
    
    return result

@router.get("/current-templates")
async def get_current_templates(db: Session = Depends(get_db)):
    """è·å–å½“å‰åº”ç”¨çš„æ¨¡æ¿æ¨¡å¼"""
    state = get_or_create_template_state(db)
    
    image_template_name = "éšæœºæ¨¡å¼"
    content_template_name = "éšæœºæ¨¡å¼"
    
    if state.image_template_enabled and state.current_image_template_id:
        image_template = db.query(ImageTemplate).filter(ImageTemplate.id == state.current_image_template_id).first()
        if image_template:
            image_template_name = image_template.name
    
    if state.content_template_enabled and state.current_content_template_id:
        content_template = db.query(ContentTemplate).filter(ContentTemplate.id == state.current_content_template_id).first()
        if content_template:
            content_template_name = content_template.name
    
    return {
        "success": True,
        "image_template_mode": {
            "is_random_mode": not state.image_template_enabled,
            "current_template_id": state.current_image_template_id if state.image_template_enabled else None,
            "current_template_name": image_template_name,
            "mode": state.image_template_mode
        },
        "content_template_mode": {
            "is_random_mode": not state.content_template_enabled,
            "current_template_id": state.current_content_template_id if state.content_template_enabled else None,
            "current_template_name": content_template_name,
            "mode": state.content_template_mode
        }
    }

@router.post("/apply-image-template/{template_id}")
async def apply_image_template(template_id: int, db: Session = Depends(get_db)):
    """åº”ç”¨æŒ‡å®šçš„å›¾ç‰‡æ¨¡æ¿"""
    template = db.query(ImageTemplate).filter(ImageTemplate.id == template_id).first()
    if not template:
        raise HTTPException(status_code=404, detail="æ¨¡æ¿æœªæ‰¾åˆ°")
    
    # æ›´æ–°æ¨¡æ¿çŠ¶æ€
    state = get_or_create_template_state(db)
    state.current_image_template_id = template_id
    state.image_template_mode = template.template_type  # 'insert' or 'overlay'
    state.image_template_enabled = True
    db.commit()
    
    return {
        "success": True, 
        "message": f"å·²åº”ç”¨å›¾ç‰‡æ¨¡æ¿: {template.name}", 
        "template_id": template_id,
        "mode": template.template_type
    }

@router.post("/exit-current-template")
async def exit_current_template(db: Session = Depends(get_db)):
    """é€€å‡ºå½“å‰æŒ‡å®šçš„å›¾ç‰‡æ¨¡æ¿"""
    state = get_or_create_template_state(db)
    state.current_image_template_id = None
    state.image_template_mode = 'random'
    state.image_template_enabled = False
    db.commit()
    
    return {"success": True, "message": "å·²åˆ‡æ¢ä¸ºéšæœºæ¨¡å¼"}

@router.get("/get-template-status")
async def get_template_status(db: Session = Depends(get_db)):
    """è·å–å½“å‰æ¨¡æ¿æŒ‡å®šçŠ¶æ€"""
    state = get_or_create_template_state(db)
    
    has_template = state.image_template_enabled and state.current_image_template_id is not None
    template_name = "éšæœºæ¨¡å¼"
    template_id = None
    
    if has_template:
        template = db.query(ImageTemplate).filter(ImageTemplate.id == state.current_image_template_id).first()
        if template:
            template_name = template.name
            template_id = template.id
    
    return {
        "success": True,
        "has_template": has_template,
        "template_name": template_name,
        "template_id": template_id,
        "mode": state.image_template_mode
    }

@router.post("/apply-content-template/{template_id}")
async def apply_content_template(template_id: int, db: Session = Depends(get_db)):
    """åº”ç”¨æŒ‡å®šçš„å†…å®¹æ¨¡æ¿"""
    template = db.query(ContentTemplate).filter(ContentTemplate.id == template_id).first()
    if not template:
        raise HTTPException(status_code=404, detail="æ¨¡æ¿æœªæ‰¾åˆ°")
    
    # æ›´æ–°æ¨¡æ¿çŠ¶æ€
    state = get_or_create_template_state(db)
    state.current_content_template_id = template_id
    state.content_template_mode = 'specific'
    state.content_template_enabled = True
    db.commit()
    
    return {
        "success": True, 
        "message": f"å·²åº”ç”¨å†…å®¹æ¨¡æ¿: {template.name}", 
        "template_id": template_id
    }

@router.post("/enable-content-random-mode")
async def enable_content_random_mode(db: Session = Depends(get_db)):
    """å¯ç”¨å†…å®¹æ¨¡æ¿éšæœºæ¨¡å¼"""
    state = get_or_create_template_state(db)
    state.current_content_template_id = None
    state.content_template_mode = 'random'
    state.content_template_enabled = False
    db.commit()
    
    return {"success": True, "message": "å·²å¯ç”¨å†…å®¹æ¨¡æ¿éšæœºæ¨¡å¼"}

@router.get("/get-current-image-template")
async def get_current_image_template(material_id: Optional[int] = None, db: Session = Depends(get_db)):
    """è·å–å½“å‰å›¾ç‰‡æ¨¡æ¿ï¼ˆç”¨äºå‘å¸ƒæ—¶åº”ç”¨ï¼‰"""
    state = get_or_create_template_state(db)
    
    template = None
    
    if state.image_template_enabled and state.current_image_template_id:
        # ä½¿ç”¨æŒ‡å®šæ¨¡æ¿
        template = db.query(ImageTemplate).filter(ImageTemplate.id == state.current_image_template_id).first()
    else:
        # éšæœºé€‰æ‹©æ¨¡æ¿
        templates = db.query(ImageTemplate).all()
        if templates:
            template = random.choice(templates)
    
    if not template:
        return {"success": False, "message": "æ²¡æœ‰å¯ç”¨çš„å›¾ç‰‡æ¨¡æ¿"}
    
    template_data = {
        "id": template.id,
        "name": template.name,
        "template_type": template.template_type,
        "text_style": template.text_style,
        "text_color": template.text_color,
        "background_style": template.background_style,
        "font_size": template.font_size,
        "line_height": template.line_height,
        "mask_opacity": template.mask_opacity,
        "text_lines": template.text_lines,
        "custom_background_path": template.custom_background_path
    }
    
    return {"success": True, "template": template_data, "mode": state.image_template_mode}

@router.get("/get-current-content-template")
async def get_current_content_template(db: Session = Depends(get_db)):
    """è·å–å½“å‰å†…å®¹æ¨¡æ¿ï¼ˆç”¨äºå‘å¸ƒæ—¶åº”ç”¨ï¼‰"""
    state = get_or_create_template_state(db)
    
    template = None
    
    if state.content_template_enabled and state.current_content_template_id:
        # ä½¿ç”¨æŒ‡å®šæ¨¡æ¿
        template = db.query(ContentTemplate).filter(ContentTemplate.id == state.current_content_template_id).first()
    else:
        # éšæœºé€‰æ‹©æ¨¡æ¿
        templates = db.query(ContentTemplate).all()
        if templates:
            template = random.choice(templates)
    
    if not template:
        return {"success": False, "message": "æ²¡æœ‰å¯ç”¨çš„å†…å®¹æ¨¡æ¿"}
    
    # è§£æJSONå­—æ®µ
    description_templates = []
    topic_templates = []
    
    if template.description_templates:
        try:
            description_templates = json.loads(template.description_templates)
        except:
            description_templates = []
    
    if template.topic_templates:
        try:
            topic_templates = json.loads(template.topic_templates)
        except:
            topic_templates = []
    
    return {
        "success": True,
        "template": {
            "id": template.id,
            "name": template.name,
            "description_templates": description_templates,
            "use_random_description": template.use_random_description,
            "no_description": template.no_description,
            "topic_templates": topic_templates,
            "topic_count": template.topic_count
        }
    }

# æ–°å¢APIç«¯ç‚¹
@router.post("/save-image-template")
async def save_image_template(template: ImageTemplateCreate, db: Session = Depends(get_db)):
    """ä¿å­˜å›¾ç‰‡æ¨¡æ¿"""
    try:
        db_template = ImageTemplate(
            name=template.name,
            template_type=template.template_type,
            text_style=template.text_style,
            text_color=template.text_color,
            background_style=template.background_style,
            font_size=template.font_size,
            line_height=template.line_height,
            mask_opacity=template.mask_opacity,
            text_lines=template.text_lines,
            custom_background_path=template.custom_background_path
        )
        
        db.add(db_template)
        db.commit()
        db.refresh(db_template)
        
        return {
            "success": True, 
            "message": f"å›¾ç‰‡æ¨¡æ¿ '{template.name}' ä¿å­˜æˆåŠŸ",
            "template_id": db_template.id
        }
    except Exception as e:
        raise HTTPException(status_code=500, detail=f"ä¿å­˜æ¨¡æ¿å¤±è´¥: {str(e)}")

@router.delete("/image-template/{template_id}")
async def delete_image_template(template_id: int, db: Session = Depends(get_db)):
    """åˆ é™¤å›¾ç‰‡æ¨¡æ¿"""
    template = db.query(ImageTemplate).filter(ImageTemplate.id == template_id).first()
    if not template:
        raise HTTPException(status_code=404, detail="æ¨¡æ¿æœªæ‰¾åˆ°")
    
    # å¦‚æœæ˜¯å½“å‰åº”ç”¨çš„æ¨¡æ¿ï¼Œå…ˆé€€å‡º
    state = get_or_create_template_state(db)
    if state.current_image_template_id == template_id:
        state.current_image_template_id = None
        state.image_template_enabled = False
    
    template_name = template.name
    db.delete(template)
    db.commit()
    
    return {"success": True, "message": f"æ¨¡æ¿ '{template_name}' å·²åˆ é™¤"}

@router.post("/save-content-template")
async def save_content_template(template: ContentTemplateCreate, db: Session = Depends(get_db)):
    """ä¿å­˜å†…å®¹æ¨¡æ¿"""
    try:
        db_template = ContentTemplate(
            name=template.name,
            description_templates=json.dumps(template.description_templates, ensure_ascii=False),
            use_random_description=template.use_random_description,
            no_description=template.no_description,
            topic_templates=json.dumps(template.topic_templates, ensure_ascii=False),
            topic_count=template.topic_count
        )
        
        db.add(db_template)
        db.commit()
        db.refresh(db_template)
        
        return {
            "success": True,
            "message": f"å†…å®¹æ¨¡æ¿ '{template.name}' ä¿å­˜æˆåŠŸ",
            "template_id": db_template.id
        }
    except Exception as e:
        raise HTTPException(status_code=500, detail=f"ä¿å­˜å†…å®¹æ¨¡æ¿å¤±è´¥: {str(e)}")

@router.delete("/content-template/{template_id}")
async def delete_content_template(template_id: int, db: Session = Depends(get_db)):
    """åˆ é™¤å†…å®¹æ¨¡æ¿"""
    template = db.query(ContentTemplate).filter(ContentTemplate.id == template_id).first()
    if not template:
        raise HTTPException(status_code=404, detail="æ¨¡æ¿æœªæ‰¾åˆ°")
    
    # å¦‚æœæ˜¯å½“å‰åº”ç”¨çš„æ¨¡æ¿ï¼Œå…ˆé€€å‡º
    state = get_or_create_template_state(db)
    if state.current_content_template_id == template_id:
        state.current_content_template_id = None
        state.content_template_enabled = False
    
    template_name = template.name
    db.delete(template)
    db.commit()
    
    return {"success": True, "message": f"å†…å®¹æ¨¡æ¿ '{template_name}' å·²åˆ é™¤"}

@router.post("/upload-background")
async def upload_background(file: UploadFile = File(...), db: Session = Depends(get_db)):
    """ä¸Šä¼ è‡ªå®šä¹‰èƒŒæ™¯å›¾ç‰‡"""
    if not file.content_type.startswith('image/'):
        raise HTTPException(status_code=400, detail="è¯·ä¸Šä¼ å›¾ç‰‡æ–‡ä»¶")
    
    # åˆ›å»ºä¸Šä¼ ç›®å½•
    upload_dir = Path("app/static/uploads/backgrounds")
    upload_dir.mkdir(parents=True, exist_ok=True)
    
    # ç”Ÿæˆå”¯ä¸€æ–‡ä»¶å
    file_extension = Path(file.filename).suffix
    filename = f"{datetime.now().strftime('%Y%m%d_%H%M%S')}_{random.randint(1000, 9999)}{file_extension}"
    file_path = upload_dir / filename
    
    try:
        with open(file_path, "wb") as buffer:
            shutil.copyfileobj(file.file, buffer)
        
        # è¿”å›ç›¸å¯¹è·¯å¾„
        relative_path = f"/static/uploads/backgrounds/{filename}"
        
        return {
            "success": True,
            "message": "èƒŒæ™¯å›¾ç‰‡ä¸Šä¼ æˆåŠŸ",
            "file_path": relative_path
        }
    except Exception as e:
        raise HTTPException(status_code=500, detail=f"ä¸Šä¼ å¤±è´¥: {str(e)}")

class ContentPreviewRequest(BaseModel):
    template_id: Optional[int] = None

@router.post("/generate-content-preview")
async def generate_content_preview(request: ContentPreviewRequest = ContentPreviewRequest(), db: Session = Depends(get_db)):
    """ç”Ÿæˆå†…å®¹é¢„è§ˆ"""
    template_id = request.template_id if request else None
    
    if template_id:
        template = db.query(ContentTemplate).filter(ContentTemplate.id == template_id).first()
        if not template:
            raise HTTPException(status_code=404, detail="æ¨¡æ¿æœªæ‰¾åˆ°")
    else:
        # è·å–å½“å‰æ¨¡æ¿æˆ–éšæœºé€‰æ‹©
        state = get_or_create_template_state(db)
        if state.content_template_enabled and state.current_content_template_id:
            template = db.query(ContentTemplate).filter(ContentTemplate.id == state.current_content_template_id).first()
        else:
            templates = db.query(ContentTemplate).all()
            if not templates:
                return {"success": False, "message": "æ²¡æœ‰å¯ç”¨çš„å†…å®¹æ¨¡æ¿"}
            template = random.choice(templates)
    
    # ç”Ÿæˆé¢„è§ˆå†…å®¹ - ä½¿ç”¨å›ºå®šç¤ºä¾‹æ ‡é¢˜ï¼Œä¸æ˜¾ç¤ºåœ°åŒºæ ‡ç­¾
    preview_content = await generate_template_content(template, "ç¤ºä¾‹æ ‡é¢˜ï¼š9æœˆ6æ—¥æ‹›è˜ä¿¡æ¯", for_preview=True)
    
    return {
        "success": True,
        "content": preview_content,
        "template_name": template.name
    }

# è¾…åŠ©å‡½æ•°
def get_or_create_template_state(db: Session) -> TemplateState:
    """è·å–æˆ–åˆ›å»ºæ¨¡æ¿çŠ¶æ€"""
    state = db.query(TemplateState).first()
    if not state:
        state = TemplateState()
        db.add(state)
        db.commit()
        db.refresh(state)
    return state

def extract_region_from_title(title: str) -> str:
    """ä»æ ‡é¢˜ä¸­æå–åœ°åŒºä¿¡æ¯ - æå–å¹´å­—å’Œå¤®å›½ä¼ä¹‹é—´çš„æ–‡å­—"""
    # ä½¿ç”¨æ­£åˆ™è¡¨è¾¾å¼æå–å¹´å­—å’Œå¤®å›½ä¼ä¹‹é—´çš„æ–‡å­—
    match = re.search(r"å¹´(.+?)å¤®å›½ä¼", title)
    if match:
        return match.group(1)
    
    # å¦‚æœæ²¡æœ‰æ‰¾åˆ°ï¼Œå°è¯•å…¶ä»–æ¨¡å¼
    match = re.search(r"å¹´(.+?)å›½ä¼", title)
    if match:
        return match.group(1)
    
    # å¦‚æœéƒ½æ²¡æœ‰æ‰¾åˆ°ï¼Œè¿”å›é»˜è®¤å€¼
    return "å…¨å›½"
    """ä»æ ‡é¢˜ä¸­æå–åœ°åŒºä¿¡æ¯"""
    regions = ['åŒ—äº¬', 'ä¸Šæµ·', 'å¹¿å·', 'æ·±åœ³', 'æ­å·', 'æˆéƒ½', 'æ­¦æ±‰', 'è¥¿å®‰', 'å—äº¬', 'è‹å·']
    for region in regions:
        if region in title:
            return region
    return 'å…¨å›½'

async def generate_template_content(template: ContentTemplate, material_title: str, for_preview: bool = False) -> str:
    """æ ¹æ®æ¨¡æ¿ç”Ÿæˆå†…å®¹"""
    content_parts = []
    
    # è§£ææ¨¡æ¿æ•°æ®
    topic_templates = []
    if template.topic_templates:
        try:
            topic_templates = json.loads(template.topic_templates)
        except:
            pass
    
    # ç”Ÿæˆè¯é¢˜
    topics = []
    if topic_templates:
        if for_preview:
            # é¢„è§ˆæ—¶æ˜¾ç¤ºæ‰€æœ‰è¯é¢˜ï¼ˆæœ€å¤šæ˜¾ç¤ºå‰10ä¸ªï¼‰
            topics.extend(topic_templates[:10])
        else:
            # å‘å¸ƒæ—¶ä»æ¨¡æ¿ä¸­éšæœºé€‰æ‹©è¯é¢˜
            selected_topics = random.sample(topic_templates, min(template.topic_count, len(topic_templates)))
            topics.extend(selected_topics)
    
    # æ·»åŠ å›ºå®šçš„åœ°åŒºç›¸å…³è¯é¢˜ï¼ˆä»…å‘å¸ƒæ—¶æ·»åŠ ï¼Œé¢„è§ˆæ—¶ä¸æ·»åŠ ï¼‰
    if not for_preview:
        region = extract_region_from_title(material_title)
        topics.append(f"#{region}å›½ä¼")
        topics.append(f"#{region}å›½ä¼æ‹›è˜")
    
    # ç»„åˆå†…å®¹
    if not template.no_description:
        description_templates = []
        if template.description_templates:
            try:
                description_templates = json.loads(template.description_templates)
            except:
                pass
        
        if description_templates:
            # ç›´æ¥ä½¿ç”¨æ‰€æœ‰æè¿°å†…å®¹ï¼Œä¸éšæœºé€‰æ‹©
            content_parts.extend(description_templates)
    
    # æ·»åŠ è¯é¢˜
    if topics:
        content_parts.append(' '.join(topics))
    
    return '\n\n'.join(content_parts) if content_parts else ''

def parse_material_title_for_image_text(title: str, text_lines: int) -> List[str]:
    """è§£æç´ ææ ‡é¢˜ï¼Œç”Ÿæˆå›¾ç‰‡æ–‡å­—å†…å®¹"""
    lines = []
    
    # æå–æ—¥æœŸ
    date_match = re.search(r'(\d+æœˆ\d+æ—¥|\d+\/\d+)', title)
    if date_match:
        lines.append(date_match.group(1))
    
    # æå–åœ°åŒºå’Œä¼ä¸šç±»å‹
    region = extract_region_from_title(title)
    enterprise_types = ['å¤®ä¼', 'å›½ä¼', 'å¤–ä¼', 'æ°‘ä¼']
    enterprise_type = 'å¤®å›½ä¼'  # é»˜è®¤
    
    for etype in enterprise_types:
        if etype in title:
            enterprise_type = etype
            break
    
    lines.append(f"{region}{enterprise_type}")
    lines.append("æ‹›è˜ä¿¡æ¯å·®")
    
    # å¦‚æœæ˜¯4è¡Œæ¨¡å¼ï¼Œæ·»åŠ å¼•å¯¼æ–‡å­—
    if text_lines > 3:
        lines.append("å³åˆ’æ›´å¤šğŸ‘‰ğŸ»")
    
    return lines[:text_lines]

class GenerateImageRequest(BaseModel):
    template_config: dict
    text_lines: List[str]
    mode: str = 'insert'
    output_path: str

@router.post("/generate-image-from-canvas")
async def generate_image_from_canvas(request: GenerateImageRequest):
    """æ¥æ”¶å‰ç«¯Canvasç”Ÿæˆçš„å›¾ç‰‡æ•°æ®å¹¶ä¿å­˜åˆ°æŒ‡å®šè·¯å¾„"""
    try:
        # è¿™ä¸ªAPIä¸»è¦ç”¨ä½œå‰ç«¯å’Œåç«¯ä¹‹é—´çš„æ¡¥æ¢
        # å®é™…çš„å›¾ç‰‡ç”Ÿæˆä¼šåœ¨å‰ç«¯å®Œæˆï¼Œç„¶åé€šè¿‡ save-generated-image APIä¿å­˜
        
        return {
            "success": True,
            "message": "è¯·ä½¿ç”¨å‰ç«¯Canvasç”Ÿæˆå›¾ç‰‡åè°ƒç”¨save-generated-image API",
            "config": request.template_config
        }
    except Exception as e:
        raise HTTPException(status_code=500, detail=f"ç”Ÿæˆå›¾ç‰‡å¤±è´¥: {str(e)}")

class SaveGeneratedImageRequest(BaseModel):
    image_data: str  # Base64å›¾ç‰‡æ•°æ®
    output_path: str  # è¾“å‡ºè·¯å¾„
    filename: Optional[str] = None  # å¯é€‰çš„æ–‡ä»¶å

@router.post("/save-generated-image") 
async def save_generated_image(request: SaveGeneratedImageRequest):
    """ä¿å­˜å‰ç«¯ç”Ÿæˆçš„Base64å›¾ç‰‡æ•°æ®åˆ°æŒ‡å®šè·¯å¾„"""
    try:
        # è§£æBase64å›¾ç‰‡æ•°æ®
        if ',' in request.image_data:
            # ç§»é™¤data:image/png;base64,å‰ç¼€
            base64_data = request.image_data.split(',')[1]
        else:
            base64_data = request.image_data
            
        # è§£ç å›¾ç‰‡æ•°æ®
        image_bytes = base64.b64decode(base64_data)
        
        # ç¡®ä¿è¾“å‡ºç›®å½•å­˜åœ¨
        output_dir = Path(request.output_path)
        output_dir.mkdir(parents=True, exist_ok=True)
        
        # ç”Ÿæˆæ–‡ä»¶å
        if request.filename:
            filename = request.filename
        else:
            filename = f"generated_{uuid.uuid4().hex[:8]}.png"
            
        # ç¡®ä¿æ–‡ä»¶æ‰©å±•åä¸º.png
        if not filename.endswith('.png'):
            filename += '.png'
            
        # ä¿å­˜å›¾ç‰‡æ–‡ä»¶
        output_file = output_dir / filename
        with open(output_file, 'wb') as f:
            f.write(image_bytes)
            
        return {
            "success": True,
            "message": f"å›¾ç‰‡å·²ä¿å­˜: {filename}",
            "file_path": str(output_file),
            "filename": filename
        }
        
    except Exception as e:
        raise HTTPException(status_code=500, detail=f"ä¿å­˜å›¾ç‰‡å¤±è´¥: {str(e)}")

@router.post("/generate-template-image-for-material")
async def generate_template_image_for_material(
    material_id: int,
    db: Session = Depends(get_db)
):
    """ä¸ºæŒ‡å®šç´ æç”Ÿæˆæ¨¡ç‰ˆå›¾ç‰‡"""
    try:
        # è¿™ä¸ªAPIå°†ä½œä¸ºå‘å¸ƒæµç¨‹çš„ä¸€éƒ¨åˆ†è¢«è°ƒç”¨
        # å®ƒä¼šè¿”å›ç”Ÿæˆé…ç½®ï¼Œè®©å‰ç«¯Canvasç”Ÿæˆå›¾ç‰‡
        
        # è·å–ç´ æä¿¡æ¯
        from models.database import XiaohongshuMaterial
        material = db.query(XiaohongshuMaterial).filter(XiaohongshuMaterial.id == material_id).first()
        if not material:
            raise HTTPException(status_code=404, detail="ç´ æä¸å­˜åœ¨")
            
        # è·å–å½“å‰æ¨¡ç‰ˆçŠ¶æ€
        template_state = get_or_create_template_state(db)
        
        # è·å–å›¾ç‰‡æ¨¡ç‰ˆ
        template = None
        if template_state.image_template_enabled and template_state.current_image_template_id:
            template = db.query(ImageTemplate).filter(
                ImageTemplate.id == template_state.current_image_template_id
            ).first()
        else:
            # éšæœºé€‰æ‹©æ¨¡ç‰ˆ
            templates = db.query(ImageTemplate).all()
            if templates:
                template = random.choice(templates)
                
        if not template:
            return {"success": False, "message": "æ²¡æœ‰å¯ç”¨çš„å›¾ç‰‡æ¨¡ç‰ˆ"}
            
        # è§£æç´ ææ ‡é¢˜ç”Ÿæˆæ–‡å­—å†…å®¹
        text_lines = parse_material_title_for_image_text(material.title, template.text_lines)
        
        # æ„å»ºæ¨¡ç‰ˆé…ç½®
        template_config = {
            "text_style": template.text_style,
            "text_color": template.text_color,
            "background_style": template.background_style,
            "font_size": template.font_size,
            "line_height": float(template.line_height),
            "mask_opacity": float(template.mask_opacity),
            "custom_background_path": template.custom_background_path
        }
        
        return {
            "success": True,
            "template_config": template_config,
            "text_lines": text_lines,
            "mode": template.template_type,
            "output_path": material.folder_path,
            "material_id": material_id,
            "template_name": template.name
        }
        
    except Exception as e:
        raise HTTPException(status_code=500, detail=f"ç”Ÿæˆæ¨¡ç‰ˆå›¾ç‰‡é…ç½®å¤±è´¥: {str(e)}")