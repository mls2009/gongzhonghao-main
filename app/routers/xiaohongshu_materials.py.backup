from fastapi import APIRouter, Depends, HTTPException
from sqlalchemy.orm import Session
from models.database import get_db, XiaohongshuMaterial, XiaohongshuSettings, Account, TemplateState, ImageTemplate, ContentTemplate
from typing import List, Optional
from pydantic import BaseModel
import json
import logging
import os
from pathlib import Path
import re
from datetime import datetime
import random
import importlib.util

# æœ¬åœ°æ¨¡æ¿ç®¡ç†å‡½æ•°å®šä¹‰
def get_or_create_template_state(db: Session):
    """è·å–æˆ–åˆ›å»ºæ¨¡æ¿çŠ¶æ€"""
    state = db.query(TemplateState).first()
    if not state:
        state = TemplateState()
        db.add(state)
        db.commit()
        db.refresh(state)
    return state

def extract_region_from_title(title: str) -> str:
    """ä»æ ‡é¢˜ä¸­æå–åœ°åŒºä¿¡æ¯"""
    regions = ['åŒ—äº¬', 'ä¸Šæµ·', 'å¹¿å·', 'æ·±åœ³', 'æ­å·', 'æˆéƒ½', 'æ­¦æ±‰', 'è¥¿å®‰', 'å—äº¬', 'è‹å·']
    for region in regions:
        if region in title:
            return region
    return 'å…¨å›½'

def parse_material_title_for_image_text(title: str, text_lines: int) -> List[str]:
    """è§£æç´ ææ ‡é¢˜ï¼Œç”Ÿæˆå›¾ç‰‡æ–‡å­—å†…å®¹"""
    lines = []
    
    # æå–æ—¥æœŸ
    date_match = re.search(r'(\d+æœˆ\d+æ—¥|\d+\/\d+)', title)
    if date_match:
        lines.append(date_match.group(1))
    
    # æå–åœ°åŒºå’Œä¼ä¸šç±»å‹
    region = extract_region_from_title(title)
    enterprise_types = ['å¤®ä¼', 'å›½ä¼', 'å¤–ä¼', 'æ°‘ä¼']
    enterprise_type = 'å¤®å›½ä¼'  # é»˜è®¤
    
    for etype in enterprise_types:
        if etype in title:
            enterprise_type = etype
            break
    
    lines.append(f"{region}{enterprise_type}")
    lines.append("æ‹›è˜ä¿¡æ¯å·®")
    
    # å¦‚æœæ˜¯4è¡Œæ¨¡å¼ï¼Œæ·»åŠ å¼•å¯¼æ–‡å­—
    if text_lines > 3:
        lines.append("å³åˆ’æ›´å¤šğŸ‘‰ğŸ»")
    
    return lines[:text_lines]

async def generate_template_content(template: ContentTemplate, material_title: str) -> str:
    """æ ¹æ®æ¨¡æ¿ç”Ÿæˆå†…å®¹"""
    content_parts = []
    
    # è§£ææ¨¡æ¿æ•°æ®
    topic_templates = []
    if template.topic_templates:
        try:
            topic_templates = json.loads(template.topic_templates)
        except:
            pass
    
    # ç”Ÿæˆè¯é¢˜
    topics = []
    if topic_templates:
        # ä»æ¨¡æ¿ä¸­éšæœºé€‰æ‹©è¯é¢˜
        selected_topics = random.sample(topic_templates, min(template.topic_count, len(topic_templates)))
        topics.extend(selected_topics)
    
    # æ·»åŠ å›ºå®šçš„åœ°åŒºç›¸å…³è¯é¢˜
    region = extract_region_from_title(material_title)
    topics.append(f"#{region}å›½ä¼")
    topics.append(f"#{region}å›½ä¼æ‹›è˜")
    
    # ç»„åˆå†…å®¹
    if not template.no_description:
        description_templates = []
        if template.description_templates:
            try:
                description_templates = json.loads(template.description_templates)
            except:
                pass
        
        if description_templates and template.use_random_description:
            content_parts.append(random.choice(description_templates))
    
    # æ·»åŠ è¯é¢˜
    if topics:
        content_parts.append(' '.join(topics))
    
    return '\n\n'.join(content_parts) if content_parts else ''

logger = logging.getLogger(__name__)

router = APIRouter(prefix="/api/xiaohongshu-materials", tags=["xiaohongshu-materials"])

class BatchPublishRequest(BaseModel):
    material_ids: List[int]
    schedule_publish: bool = False
    schedule_time: str = None
    add_product: bool = False

class UpdateAccountRequest(BaseModel):
    account_id: int

class UpdateTitleRequest(BaseModel):
    title: str

class UpdateStatusRequest(BaseModel):
    status: str

class DirectPublishRequest(BaseModel):
    add_product: bool = False
    default_mode: str = None

@router.get("")
async def get_xiaohongshu_materials(
    status: str = None,
    db: Session = Depends(get_db)
):
    """è·å–å°çº¢ä¹¦ç´ æåˆ—è¡¨ - ä»¿ç…§å·¥ä½œåŒºææ–™æ¶æ„"""
    try:
        logger.info(f"Getting xiaohongshu materials with status: {status}")
        
        # æ„å»ºåŸºæœ¬æŸ¥è¯¢
        query = db.query(XiaohongshuMaterial)
        
        # æ ¹æ®çŠ¶æ€ç­›é€‰
        if status == "published":
            query = query.filter(XiaohongshuMaterial.status == "published")
        elif status == "unpublished":
            query = query.filter(XiaohongshuMaterial.status == "unpublished")
        elif status == "scheduled":
            query = query.filter(
                XiaohongshuMaterial.status == "unpublished",
                XiaohongshuMaterial.schedule_time != None
            )
        
        # æŒ‰IDé™åºæ’åˆ—
        materials = query.order_by(XiaohongshuMaterial.id.desc()).all()
        logger.info(f"Found {len(materials)} materials")
        
        # è·å–æ‰€æœ‰å°çº¢ä¹¦è´¦å·
        accounts = db.query(Account).filter(
            Account.account_type == "å°çº¢ä¹¦",
            Account.status == "active"
        ).all()
        logger.info(f"Found {len(accounts)} active xiaohongshu accounts")
        
        # åºåˆ—åŒ–ç´ ææ•°æ®
        serialized_materials = []
        for material in materials:
            serialized_materials.append({
                "id": material.id,
                "title": material.title,
                "email_subject": material.email_subject,
                "folder_path": material.folder_path,
                "image_count": material.image_count,
                "status": material.status,
                "publish_status": material.publish_status,
                "publish_time": material.publish_time.isoformat() if material.publish_time else None,
                "account_id": material.account_id,
                "author_name": None,  # å°†åœ¨å‰ç«¯å¤„ç†
                "account_type": None,  # å°†åœ¨å‰ç«¯å¤„ç†
                "schedule_time": material.schedule_time.isoformat() if material.schedule_time else None,
                "schedule_status": "scheduled" if material.schedule_time else None,
                "error_message": material.error_message,
                "created_at": material.created_at.isoformat() if material.created_at else None
            })
        
        # åºåˆ—åŒ–è´¦å·æ•°æ®
        serialized_accounts = []
        for account in accounts:
            serialized_accounts.append({
                "id": account.id,
                "username": account.username,
                "author_name": account.author_name,
                "account_type": account.account_type,
                "status": account.status
            })
        
        return {
            "materials": serialized_materials,
            "accounts": serialized_accounts
        }
    except Exception as e:
        logger.error(f"Error getting xiaohongshu materials: {str(e)}")
        raise HTTPException(status_code=500, detail=str(e))

@router.post("/fetch-email-materials")
async def fetch_email_materials(db: Session = Depends(get_db)):
    """è·å–é‚®ç®±ç´ æ - ä»QQé‚®ç®±è·å–åŒ…å«'æœ€æ–°æ‹›è˜ä¿¡æ¯'çš„é‚®ä»¶"""
    from utils.email_handler import fetch_qq_email_materials
    from datetime import datetime
    
    try:
        # æ£€æŸ¥æ˜¯å¦æœ‰å°çº¢ä¹¦è®¾ç½®
        settings = db.query(XiaohongshuSettings).first()
        if not settings or not settings.materials_path:
            raise HTTPException(status_code=400, detail="è¯·å…ˆåœ¨è®¾ç½®é¡µé¢é…ç½®å°çº¢ä¹¦ç´ æåº“è·¯å¾„")
        
        if not os.path.exists(settings.materials_path):
            raise HTTPException(status_code=400, detail="å°çº¢ä¹¦ç´ æåº“è·¯å¾„ä¸å­˜åœ¨")
        
        logger.info(f"å¼€å§‹ä»é‚®ç®±è·å–ç´ æï¼Œä¿å­˜åˆ°è·¯å¾„: {settings.materials_path}")
        
        # è·å–åœ°åŒºè´¦å·æ˜ å°„é…ç½®
        region_mapping = {}
        if settings.region_account_mapping:
            try:
                region_mapping = json.loads(settings.region_account_mapping)
                logger.info(f"è·å–é‚®ç®±ç´ ææ—¶åº”ç”¨åœ°åŒºæ˜ å°„é…ç½®: {region_mapping}")
            except:
                logger.warning("è§£æåœ°åŒºè´¦å·æ˜ å°„é…ç½®å¤±è´¥")
        
        # è°ƒç”¨é‚®ç®±å¤„ç†å‡½æ•°
        result = fetch_qq_email_materials(settings.materials_path)
        
        if result["success"]:
            # é‡æ–°æ‰«æç´ æåº“ä»¥æ›´æ–°æ•°æ®åº“
            try:
                # è·å–ç°æœ‰ç´ æï¼Œé¿å…é‡å¤æ·»åŠ 
                existing_materials = {material.title: material for material in 
                                    db.query(XiaohongshuMaterial).all()}
                
                added_count = 0
                updated_count = 0
                
                # æ‰«ææ–°åˆ›å»ºçš„æ–‡ä»¶å¤¹
                for item in os.listdir(settings.materials_path):
                    folder_path = os.path.join(settings.materials_path, item)
                    
                    if not os.path.isdir(folder_path):
                        continue
                    
                    # ç»Ÿè®¡å›¾ç‰‡æ•°é‡
                    image_extensions = {'.jpg', '.jpeg', '.png', '.gif', '.bmp', '.webp'}
                    image_count = 0
                    
                    try:
                        for file in os.listdir(folder_path):
                            file_ext = os.path.splitext(file.lower())[1]
                            if file_ext in image_extensions:
                                image_count += 1
                    except:
                        continue
                    
                    folder_name = item
                    
                    # æ ¹æ®åœ°åŒºæ˜ å°„è‡ªåŠ¨åˆ†é…è´¦å·
                    assigned_account_id = None
                    for region, account_id in region_mapping.items():
                        if region in folder_name:
                            assigned_account_id = account_id
                            logger.info(f"é‚®ç®±ç´ æ '{folder_name}' åŒ¹é…åœ°åŒº '{region}', è‡ªåŠ¨åˆ†é…è´¦å·ID: {account_id}")
                            break
                    
                    # æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨è¯¥ç´ æ
                    if folder_name in existing_materials:
                        # æ›´æ–°ç°æœ‰ç´ æ
                        material = existing_materials[folder_name]
                        material.folder_path = folder_path
                        material.image_count = image_count
                        # å¦‚æœæ˜¯æ–°çš„é‚®ä»¶ç´ æï¼Œè®¾ç½®é‚®ä»¶æ ‡é¢˜
                        if not material.email_subject and "æœ€æ–°æ‹›è˜ä¿¡æ¯" in folder_name:
                            material.email_subject = folder_name
                        # åº”ç”¨åœ°åŒºæ˜ å°„åˆ†é…è´¦å·
                        if assigned_account_id is not None:
                            material.account_id = assigned_account_id
                            logger.info(f"æ›´æ–°é‚®ç®±ç´ æè´¦å·åˆ†é…: {folder_name} -> è´¦å·ID: {assigned_account_id}")
                        updated_count += 1
                    else:
                        # åˆ›å»ºæ–°ç´ æè®°å½•
                        new_material = XiaohongshuMaterial(
                            title=folder_name,
                            folder_path=folder_path,
                            image_count=image_count,
                            email_subject=folder_name if "æœ€æ–°æ‹›è˜ä¿¡æ¯" in folder_name else None,
                            status="unpublished",
                            account_id=assigned_account_id,
                            created_at=datetime.now()
                        )
                        db.add(new_material)
                        added_count += 1
                        if assigned_account_id is not None:
                            logger.info(f"æ·»åŠ æ–°é‚®ç®±ç´ æ: {folder_name}, è‡ªåŠ¨åˆ†é…è´¦å·ID: {assigned_account_id}")
                        else:
                            logger.info(f"æ·»åŠ æ–°é‚®ç®±ç´ æ: {folder_name}")
                
                # æ›´æ–°æ‰«æç»Ÿè®¡
                total_folders = len([d for d in os.listdir(settings.materials_path) 
                                   if os.path.isdir(os.path.join(settings.materials_path, d))])
                settings.total_folders = total_folders
                settings.last_scan = datetime.now()
                
                db.commit()
                
                # åˆå¹¶ç»“æœä¿¡æ¯
                all_messages = result["messages"] + [
                    f"æ•°æ®åº“æ›´æ–°å®Œæˆ: æ–°å¢ {added_count} ä¸ªç´ æï¼Œæ›´æ–° {updated_count} ä¸ªç´ æ"
                ]
                
                return {
                    "success": True,
                    "message": f"æˆåŠŸå¤„ç† {result['processed_count']} å°é‚®ä»¶ï¼Œæ•°æ®åº“æ–°å¢ {added_count} ä¸ªç´ æ",
                    "processed_count": result["processed_count"],
                    "added_count": added_count,
                    "updated_count": updated_count,
                    "details": all_messages
                }
                
            except Exception as db_error:
                logger.error(f"æ›´æ–°æ•°æ®åº“æ—¶å‡ºé”™: {str(db_error)}")
                db.rollback()
                return {
                    "success": True,  # é‚®ä»¶å¤„ç†æˆåŠŸ
                    "message": f"é‚®ä»¶å¤„ç†æˆåŠŸ({result['processed_count']}å°)ï¼Œä½†æ•°æ®åº“æ›´æ–°å¤±è´¥: {str(db_error)}",
                    "processed_count": result["processed_count"],
                    "details": result["messages"] + [f"æ•°æ®åº“æ›´æ–°å¤±è´¥: {str(db_error)}"]
                }
        else:
            return {
                "success": False,
                "message": "æœªè·å–åˆ°æ–°çš„é‚®ä»¶ç´ æ",
                "processed_count": 0,
                "details": result["messages"]
            }
            
    except HTTPException:
        raise
    except Exception as e:
        logger.error(f"è·å–é‚®ç®±ç´ ææ—¶å‡ºé”™: {str(e)}")
        raise HTTPException(status_code=500, detail=f"è·å–é‚®ç®±ç´ æå¤±è´¥: {str(e)}")

@router.post("/{material_id}/account")
async def update_material_account(
    material_id: int, 
    request: UpdateAccountRequest,
    db: Session = Depends(get_db)
):
    """æ›´æ–°ç´ æå…³è”çš„è´¦å·"""
    try:
        material = db.query(XiaohongshuMaterial).filter(XiaohongshuMaterial.id == material_id).first()
        if not material:
            raise HTTPException(status_code=404, detail="ç´ ææœªæ‰¾åˆ°")
        
        # éªŒè¯è´¦å·å­˜åœ¨
        account = db.query(Account).filter(Account.id == request.account_id).first()
        if not account:
            raise HTTPException(status_code=404, detail="è´¦å·æœªæ‰¾åˆ°")
        
        # æ›´æ–°ç´ æçš„è´¦å·
        material.account_id = request.account_id
        db.commit()
        
        logger.info(f"Updated material {material_id} account to {request.account_id}")
        return {"success": True, "message": f"å·²æ›´æ–°è´¦å·: {account.username}"}
    except HTTPException:
        raise
    except Exception as e:
        logger.error(f"Error updating material account: {str(e)}")
        raise HTTPException(status_code=500, detail=str(e))

@router.put("/{material_id}/title")
async def update_material_title(
    material_id: int,
    request: UpdateTitleRequest,
    db: Session = Depends(get_db)
):
    """æ›´æ–°ç´ ææ ‡é¢˜"""
    try:
        material = db.query(XiaohongshuMaterial).filter(XiaohongshuMaterial.id == material_id).first()
        if not material:
            raise HTTPException(status_code=404, detail="ç´ ææœªæ‰¾åˆ°")
        
        material.title = request.title
        db.commit()
        
        logger.info(f"Updated material {material_id} title to: {request.title}")
        return {"success": True, "message": "æ ‡é¢˜æ›´æ–°æˆåŠŸ"}
    except HTTPException:
        raise
    except Exception as e:
        logger.error(f"Error updating material title: {str(e)}")
        raise HTTPException(status_code=500, detail=str(e))

@router.post("/{material_id}/status") 
async def update_material_status(
    material_id: int,
    request: UpdateStatusRequest,
    db: Session = Depends(get_db)
):
    """æ›´æ–°ç´ æçŠ¶æ€"""
    try:
        material = db.query(XiaohongshuMaterial).filter(XiaohongshuMaterial.id == material_id).first()
        if not material:
            raise HTTPException(status_code=404, detail="ç´ ææœªæ‰¾åˆ°")
        
        material.status = request.status
        
        # å¦‚æœè¿”å›åˆ°æœªå‘å¸ƒçŠ¶æ€ï¼Œæ¸…é™¤é¢„çº¦æ—¶é—´
        if request.status == "unpublished":
            material.schedule_time = None
            material.publish_time = None
            material.publish_status = None
            material.error_message = None
        
        db.commit()
        
        logger.info(f"Updated material {material_id} status to: {request.status}")
        return {"success": True, "message": f"çŠ¶æ€å·²æ›´æ–°ä¸º: {request.status}"}
    except HTTPException:
        raise
    except Exception as e:
        logger.error(f"Error updating material status: {str(e)}")
        raise HTTPException(status_code=500, detail=str(e))

@router.post("/publish-batch")
async def publish_batch_materials(
    request: BatchPublishRequest,
    db: Session = Depends(get_db)
):
    """æ‰¹é‡å‘å¸ƒç´ æ - ä½¿ç”¨å®Œæ•´çš„æµè§ˆå™¨è‡ªåŠ¨åŒ–å‘å¸ƒæµç¨‹"""
    try:
        logger.info(f"Batch publishing {len(request.material_ids)} materials")
        
        # éªŒè¯æ‰€æœ‰ç´ æå­˜åœ¨ä¸”æœ‰è´¦å·
        materials = []
        accounts = {}  # ç¼“å­˜è´¦å·ä¿¡æ¯
        
        for material_id in request.material_ids:
            material = db.query(XiaohongshuMaterial).filter(XiaohongshuMaterial.id == material_id).first()
            if not material:
                raise HTTPException(status_code=404, detail=f"ç´ æ {material_id} æœªæ‰¾åˆ°")
            if not material.account_id:
                raise HTTPException(status_code=400, detail=f"ç´ æ {material_id} æœªåˆ†é…è´¦å·")
            
            # è·å–è´¦å·ä¿¡æ¯
            if material.account_id not in accounts:
                account = db.query(Account).filter(Account.id == material.account_id).first()
                if not account:
                    raise HTTPException(status_code=400, detail=f"ç´ æ {material_id} å…³è”çš„è´¦å·ä¸å­˜åœ¨")
                if not account.browser_id:
                    raise HTTPException(status_code=400, detail=f"ç´ æ {material_id} å…³è”çš„è´¦å·æœªé…ç½®æµè§ˆå™¨ID")
                accounts[material.account_id] = account
            
            materials.append(material)
        
        # è·å–é€šç”¨è®¾ç½®
        template_state = get_or_create_template_state(db)
        xiaohongshu_settings = db.query(XiaohongshuSettings).first()
        
        # æ‰¹é‡å‘å¸ƒå¤„ç†
        success_count = 0
        failed_count = 0
        details = []
        
        for material in materials:
            try:
                if request.schedule_publish and request.schedule_time:
                    # é¢„çº¦å‘å¸ƒ - åªè®¾ç½®æ—¶é—´ï¼Œä¸æ‰§è¡Œå®é™…å‘å¸ƒ
                    material.schedule_time = request.schedule_time
                    material.status = "unpublished"
                    message = "å·²è®¾ç½®é¢„çº¦å‘å¸ƒ"
                    
                    success_count += 1
                    details.append({
                        "material_id": material.id,
                        "success": True,
                        "message": message
                    })
                else:
                    # ç«‹å³å‘å¸ƒ - æ‰§è¡Œå®é™…çš„æµè§ˆå™¨è‡ªåŠ¨åŒ–
                    account = accounts[material.account_id]
                    
                    # 1. åº”ç”¨æ¨¡æ¿ç”Ÿæˆå†…å®¹
                    content = ""
                    template_applied = False
                    
                    if template_state.content_template_enabled or True:
                        try:
                            content_template_result = await apply_content_template_to_material(
                                material, template_state, db
                            )
                            if content_template_result["success"]:
                                content = content_template_result.get("content", "")
                                template_applied = True
                        except Exception as e:
                            logger.error(f"Content template error for material {material.id}: {str(e)}")
                    
                    # 2. å›¾ç‰‡æ¨¡æ¿å¤„ç†å·²åœ¨å‰ç«¯å®Œæˆï¼Œè¿™é‡Œè·³è¿‡
                    # å›¾ç‰‡æ¨¡ç‰ˆç°åœ¨ç”±å‰ç«¯Canvasç”Ÿæˆå™¨å¤„ç†ï¼Œç¡®ä¿æ ·å¼ä¸€è‡´æ€§
                    logger.info(f"å›¾ç‰‡æ¨¡æ¿å¤„ç†ç”±å‰ç«¯å®Œæˆï¼Œç´ æ {material.id} è·³è¿‡åç«¯å¤„ç†")
                    
                    # 3. æ‰§è¡Œå‘å¸ƒ
                    try:
                        from utils.xiaohongshu_publisher import publish_xiaohongshu_material
                        
                        publish_result = await publish_xiaohongshu_material(
                            material_id=material.id,
                            material_title=material.title,
                            folder_path=material.folder_path,
                            account_id=material.account_id,
                            browser_id=account.browser_id,
                            content=content,
                            add_product=request.add_product
                        )
                        
                        if publish_result["success"]:
                            material.status = "published"
                            material.publish_status = "success"
                            material.publish_time = datetime.now()
                            material.error_message = None
                            
                            if template_state.image_template_enabled and template_state.current_image_template_id:
                                material.image_template_id = template_state.current_image_template_id
                                material.template_mode = template_state.image_template_mode
                            
                            success_count += 1
                            message = "å‘å¸ƒæˆåŠŸ"
                            if template_applied:
                                message += "ï¼ˆå·²åº”ç”¨æ¨¡æ¿ï¼‰"
                                
                            details.append({
                                "material_id": material.id,
                                "success": True,
                                "message": message
                            })
                        else:
                            material.publish_status = "failed"
                            material.error_message = publish_result["message"]
                            failed_count += 1
                            
                            details.append({
                                "material_id": material.id,
                                "success": False,
                                "message": f"å‘å¸ƒå¤±è´¥: {publish_result['message']}"
                            })
                            
                    except Exception as publish_error:
                        logger.error(f"Publish error for material {material.id}: {str(publish_error)}")
                        
                        material.publish_status = "failed"
                        material.error_message = str(publish_error)
                        failed_count += 1
                        
                        details.append({
                            "material_id": material.id,
                            "success": False,
                            "message": f"å‘å¸ƒè¿‡ç¨‹ä¸­å‡ºç°é”™è¯¯: {str(publish_error)}"
                        })
                        
            except Exception as e:
                failed_count += 1
                details.append({
                    "material_id": material.id,
                    "success": False,
                    "message": str(e)
                })
        
        db.commit()
        
        return {
            "success": True,
            "message": f"æ‰¹é‡å‘å¸ƒå®Œæˆï¼ŒæˆåŠŸ: {success_count}, å¤±è´¥: {failed_count}",
            "details": details
        }
    except HTTPException:
        raise
    except Exception as e:
        logger.error(f"Error in batch publish: {str(e)}")
        raise HTTPException(status_code=500, detail=str(e))

# æ¨¡æ¿åº”ç”¨è¾…åŠ©å‡½æ•°
async def apply_image_template_to_material(
    material: XiaohongshuMaterial, 
    template_state: TemplateState, 
    db: Session
) -> dict:
    """ä¸ºç´ æåº”ç”¨å›¾ç‰‡æ¨¡æ¿"""
    try:
        # è·å–å½“å‰å›¾ç‰‡æ¨¡æ¿
        template = None
        
        if template_state.image_template_enabled and template_state.current_image_template_id:
            template = db.query(ImageTemplate).filter(
                ImageTemplate.id == template_state.current_image_template_id
            ).first()
        else:
            # éšæœºé€‰æ‹©æ¨¡æ¿
            templates = db.query(ImageTemplate).all()
            if templates:
                import random
                template = random.choice(templates)
        
        if not template:
            return {"success": False, "message": "æ²¡æœ‰å¯ç”¨çš„å›¾ç‰‡æ¨¡æ¿"}
        
        # æ£€æŸ¥ç´ ææ–‡ä»¶å¤¹æ˜¯å¦å­˜åœ¨
        folder_path = Path(material.folder_path)
        if not folder_path.exists():
            return {"success": False, "message": "ç´ ææ–‡ä»¶å¤¹ä¸å­˜åœ¨"}
        
        # è·å–å›¾ç‰‡æ–‡ä»¶
        image_extensions = {'.jpg', '.jpeg', '.png', '.JPG', '.JPEG', '.PNG'}
        image_files = []
        for ext in image_extensions:
            image_files.extend(folder_path.glob(f'*{ext}'))
        
        if not image_files:
            return {"success": False, "message": "ç´ ææ–‡ä»¶å¤¹ä¸­æ²¡æœ‰å›¾ç‰‡æ–‡ä»¶"}
        
        # æŒ‰æ–‡ä»¶åæ’åºï¼Œç¡®ä¿é¡ºåºä¸€è‡´
        image_files.sort(key=lambda x: x.name)
        
        # è§£ææ ‡é¢˜ç”Ÿæˆæ–‡å­—å†…å®¹
        text_lines = parse_material_title_for_image_text(material.title, template.text_lines)
        
        # æ ¹æ®æ¨¡æ¿ç±»å‹å¤„ç†
        if template.template_type == 'overlay':
            # è¦†ç›–æ¨¡å¼ï¼šåœ¨ç¬¬ä¸€å¼ å›¾ç‰‡ä¸Šå åŠ æ–‡å­—
            result = await process_overlay_mode(
                image_files[0], template, text_lines
            )
        elif template.template_type == 'insert':
            # æ’å…¥æ¨¡å¼ï¼šåˆ›å»ºæ–°å›¾ç‰‡å¹¶æ’å…¥åˆ°ç¬¬ä¸€ä½
            result = await process_insert_mode(
                folder_path, template, text_lines, image_files
            )
        else:
            return {"success": False, "message": "æœªçŸ¥çš„æ¨¡æ¿ç±»å‹"}
        
        if result["success"]:
            # ç°åœ¨è¿”å›é…ç½®ä¿¡æ¯ï¼Œè®©å‰ç«¯Canvaså¤„ç†å›¾ç‰‡ç”Ÿæˆ
            return {
                "success": True, 
                "message": f"å›¾ç‰‡æ¨¡æ¿ '{template.name}' ({template.template_type}æ¨¡å¼) é…ç½®å·²å‡†å¤‡",
                "template_config": result.get("config"),
                "mode": result.get("mode", template.template_type),
                "text_lines": result.get("text_lines", text_lines),
                "target_path": result.get("target_file") if template.template_type == 'overlay' else result.get("target_folder"),
                "material_id": material.id,
                "template_name": template.name,
                # æ·»åŠ ä¸€ä¸ªæ ‡è¯†ï¼Œè¡¨ç¤ºéœ€è¦å‰ç«¯å¤„ç†
                "requires_frontend_processing": True
            }
        else:
            return result
            
    except Exception as e:
        logger.error(f"Error applying image template: {str(e)}")
        return {"success": False, "message": f"å›¾ç‰‡æ¨¡æ¿åº”ç”¨å¤±è´¥: {str(e)}"}

async def process_overlay_mode(image_file: Path, template: ImageTemplate, text_lines: list) -> dict:
    """å¤„ç†è¦†ç›–æ¨¡å¼ - åœ¨åŸå›¾ä¸Šå åŠ æ–‡å­—"""
    try:
        # ç°åœ¨ä½¿ç”¨å‰ç«¯Canvasç”Ÿæˆå›¾ç‰‡ï¼Œå¹¶æ›¿æ¢åŸæ–‡ä»¶
        
        # åˆ›å»ºæ¨¡ç‰ˆé…ç½®
        template_config = {
            "text_style": template.text_style,
            "text_color": template.text_color,
            "font_size": template.font_size,
            "line_height": float(template.line_height),
            "mask_opacity": float(template.mask_opacity),
            "background_style": None,  # è¦†ç›–æ¨¡å¼ä¸ä½¿ç”¨èƒŒæ™¯æ ·å¼
            "custom_background_path": str(image_file)  # ä½¿ç”¨åŸå›¾ä½œä¸ºèƒŒæ™¯
        }
        
        logger.info(f"è¦†ç›–æ¨¡å¼é…ç½®: {template_config}")
        logger.info(f"æ–‡å­—å†…å®¹: {text_lines}")
        
        return {
            "success": True, 
            "message": "è¦†ç›–æ¨¡å¼é…ç½®å·²å‡†å¤‡",
            "config": template_config,
            "mode": "overlay",
            "text_lines": text_lines,
            "target_file": str(image_file)
        }
        
    except Exception as e:
        logger.error(f"è¦†ç›–æ¨¡å¼å¤„ç†å¤±è´¥: {str(e)}")
        return {"success": False, "message": f"è¦†ç›–æ¨¡å¼å¤„ç†å¤±è´¥: {str(e)}"}

async def process_insert_mode(folder_path: Path, template: ImageTemplate, text_lines: list, existing_images: list) -> dict:
    """å¤„ç†æ’å…¥æ¨¡å¼ - åˆ›å»ºæ–°å›¾ç‰‡æ’å…¥åˆ°ç¬¬ä¸€ä½"""
    try:
        # ç°åœ¨ä½¿ç”¨å‰ç«¯Canvasç”Ÿæˆå›¾ç‰‡ï¼Œå¹¶ä¿å­˜åˆ°æ–‡ä»¶å¤¹
        
        # åˆ›å»ºæ¨¡ç‰ˆé…ç½®
        template_config = {
            "text_style": template.text_style,
            "text_color": template.text_color,
            "background_style": template.background_style,
            "font_size": template.font_size,
            "line_height": float(template.line_height),
            "mask_opacity": float(template.mask_opacity),
            "custom_background_path": template.custom_background_path
        }
        
        logger.info(f"æ’å…¥æ¨¡å¼é…ç½®: {template_config}")
        logger.info(f"æ–‡å­—å†…å®¹: {text_lines}")
        
        return {
            "success": True, 
            "message": "æ’å…¥æ¨¡å¼é…ç½®å·²å‡†å¤‡",
            "config": template_config,
            "mode": "insert", 
            "text_lines": text_lines,
            "target_folder": str(folder_path)
        }
        
    except Exception as e:
        logger.error(f"æ’å…¥æ¨¡å¼å¤„ç†å¤±è´¥: {str(e)}")
        return {"success": False, "message": f"æ’å…¥æ¨¡å¼å¤„ç†å¤±è´¥: {str(e)}"}

async def apply_content_template_to_material(
    material: XiaohongshuMaterial, 
    template_state: TemplateState, 
    db: Session
) -> dict:
    """ä¸ºç´ æåº”ç”¨å†…å®¹æ¨¡æ¿"""
    try:
        # è·å–å½“å‰å†…å®¹æ¨¡æ¿
        template = None
        
        if template_state.content_template_enabled and template_state.current_content_template_id:
            template = db.query(ContentTemplate).filter(
                ContentTemplate.id == template_state.current_content_template_id
            ).first()
        else:
            # éšæœºé€‰æ‹©æ¨¡æ¿
            templates = db.query(ContentTemplate).all()
            if templates:
                import random
                template = random.choice(templates)
        
        if not template:
            return {"success": False, "message": "æ²¡æœ‰å¯ç”¨çš„å†…å®¹æ¨¡æ¿"}
        
        # ç”Ÿæˆå†…å®¹
        content = await generate_template_content(template, material.title)
        
        if content:
            # å°†ç”Ÿæˆçš„å†…å®¹ä¿å­˜åˆ°ç´ æè®°å½•ä¸­ï¼ˆå¯ä»¥æ‰©å±•XiaohongshuMaterialæ¨¡å‹æ¥å­˜å‚¨ç”Ÿæˆçš„å†…å®¹ï¼‰
            logger.info(f"Generated content for material {material.id}: {content[:100]}...")
            
            return {
                "success": True, 
                "message": f"å†…å®¹æ¨¡æ¿ '{template.name}' åº”ç”¨æˆåŠŸ",
                "content": content
            }
        else:
            return {"success": False, "message": "å†…å®¹ç”Ÿæˆå¤±è´¥"}
            
    except Exception as e:
        logger.error(f"Error applying content template: {str(e)}")
        return {"success": False, "message": f"å†…å®¹æ¨¡æ¿åº”ç”¨å¤±è´¥: {str(e)}"}

@router.post("/{material_id}/direct-publish")
async def direct_publish_material(
    material_id: int,
    request: DirectPublishRequest,
    db: Session = Depends(get_db)
):
    """ç›´æ¥å‘å¸ƒå•ä¸ªç´ æ - ä½¿ç”¨å®Œæ•´çš„æµè§ˆå™¨è‡ªåŠ¨åŒ–å‘å¸ƒæµç¨‹"""
    try:
        material = db.query(XiaohongshuMaterial).filter(XiaohongshuMaterial.id == material_id).first()
        if not material:
            raise HTTPException(status_code=404, detail="ç´ ææœªæ‰¾åˆ°")
        
        if not material.account_id:
            raise HTTPException(status_code=400, detail="è¯·å…ˆä¸ºç´ æåˆ†é…è´¦å·")
        
        # è·å–è´¦å·ä¿¡æ¯
        account = db.query(Account).filter(Account.id == material.account_id).first()
        if not account:
            raise HTTPException(status_code=400, detail="å…³è”çš„è´¦å·ä¸å­˜åœ¨")
        
        if not account.browser_id:
            raise HTTPException(status_code=400, detail="è´¦å·æœªé…ç½®æµè§ˆå™¨ID")
        
        # è·å–å°çº¢ä¹¦è®¾ç½®
        xiaohongshu_settings = db.query(XiaohongshuSettings).first()
        # ä»å‰ç«¯è¯·æ±‚å‚æ•°è·å–æ˜¯å¦æ·»åŠ å•†å“çš„è®¾ç½®
        add_product = request.add_product
        logger.info(f"ç›´æ¥å‘å¸ƒç´ æ {material_id}ï¼Œæ·»åŠ å•†å“è®¾ç½®: {add_product}")
        
        # è·å–æ¨¡æ¿çŠ¶æ€å’Œç”Ÿæˆå†…å®¹
        template_state = get_or_create_template_state(db)
        
        # 1. åº”ç”¨å›¾ç‰‡æ¨¡æ¿ (å¦‚æœå¯ç”¨)
        template_applied = False
        error_messages = []
        
        # å›¾ç‰‡æ¨¡æ¿å¤„ç†å·²åœ¨å‰ç«¯å®Œæˆï¼Œè¿™é‡Œè·³è¿‡
        # å›¾ç‰‡æ¨¡ç‰ˆç°åœ¨ç”±å‰ç«¯Canvasç”Ÿæˆå™¨å¤„ç†ï¼Œç¡®ä¿æ ·å¼ä¸€è‡´æ€§
        logger.info(f"å›¾ç‰‡æ¨¡æ¿å¤„ç†ç”±å‰ç«¯å®Œæˆï¼Œç´ æ {material_id} è·³è¿‡åç«¯å¤„ç†")
        # å¦‚æœæœ‰å›¾ç‰‡æ¨¡ç‰ˆï¼Œæ ‡è®°ä¸ºå·²åº”ç”¨
        if template_state.image_template_enabled and template_state.current_image_template_id:
            template_applied = True
        
        # 2. ç”Ÿæˆå‘å¸ƒå†…å®¹ (åº”ç”¨å†…å®¹æ¨¡æ¿)
        content = ""
        if template_state.content_template_enabled or True:
            try:
                content_template_result = await apply_content_template_to_material(
                    material, template_state, db
                )
                if content_template_result["success"]:
                    content = content_template_result.get("content", "")
                    template_applied = True
                    logger.info(f"å†…å®¹æ¨¡æ¿åº”ç”¨æˆåŠŸ: {content_template_result['message']}")
                else:
                    error_messages.append(f"å†…å®¹æ¨¡æ¿åº”ç”¨å¤±è´¥: {content_template_result['message']}")
            except Exception as e:
                error_messages.append(f"å†…å®¹æ¨¡æ¿å¤„ç†å¼‚å¸¸: {str(e)}")
                logger.error(f"Content template error for material {material_id}: {str(e)}")
        
        # 3. æ‰§è¡Œå®é™…çš„æµè§ˆå™¨å‘å¸ƒæµç¨‹
        try:
            from utils.xiaohongshu_publisher import publish_xiaohongshu_material
            
            publish_result = await publish_xiaohongshu_material(
                material_id=material_id,
                material_title=material.title,
                folder_path=material.folder_path,
                account_id=material.account_id,
                browser_id=account.browser_id,
                content=content,
                add_product=add_product
            )
            
            if publish_result["success"]:
                # æ›´æ–°æ•°æ®åº“çŠ¶æ€
                material.status = "published"
                material.publish_status = "success"
                material.publish_time = datetime.now()
                material.error_message = None
                
                # è®°å½•æ¨¡æ¿åº”ç”¨ä¿¡æ¯
                if template_state.image_template_enabled and template_state.current_image_template_id:
                    material.image_template_id = template_state.current_image_template_id
                    material.template_mode = template_state.image_template_mode
                
                db.commit()
                
                response_message = "å‘å¸ƒæˆåŠŸ"
                if template_applied:
                    response_message += "ï¼ˆå·²åº”ç”¨æ¨¡æ¿ï¼‰"
                if error_messages:
                    response_message += f"ï¼Œä½†æ¨¡æ¿åº”ç”¨å‡ºç°è­¦å‘Š: {'; '.join(error_messages)}"
                
                return {
                    "success": True,
                    "message": response_message,
                    "template_applied": template_applied,
                    "errors": error_messages if error_messages else None
                }
            else:
                # å‘å¸ƒå¤±è´¥ï¼Œæ›´æ–°é”™è¯¯çŠ¶æ€
                material.publish_status = "failed"
                material.error_message = publish_result["message"]
                db.commit()
                
                return {
                    "success": False,
                    "message": f"å‘å¸ƒå¤±è´¥: {publish_result['message']}",
                    "template_applied": template_applied,
                    "errors": error_messages
                }
                
        except Exception as publish_error:
            logger.error(f"Browser automation publish error: {str(publish_error)}")
            
            # æ›´æ–°é”™è¯¯çŠ¶æ€
            material.publish_status = "failed"
            material.error_message = str(publish_error)
            db.commit()
            
            return {
                "success": False,
                "message": f"å‘å¸ƒè¿‡ç¨‹ä¸­å‡ºç°é”™è¯¯: {str(publish_error)}",
                "template_applied": template_applied,
                "errors": error_messages
            }
        
    except HTTPException:
        raise
    except Exception as e:
        logger.error(f"Error in direct publish: {str(e)}")
        raise HTTPException(status_code=500, detail=str(e))

@router.post("/batch-return")
async def batch_return_to_unpublished(db: Session = Depends(get_db)):
    """æ‰¹é‡è¿”å›åˆ°æœªå‘å¸ƒçŠ¶æ€"""
    try:
        # è·å–æ‰€æœ‰å·²å‘å¸ƒçš„ç´ æ
        published_materials = db.query(XiaohongshuMaterial).filter(
            XiaohongshuMaterial.status == "published"
        ).all()
        
        count = len(published_materials)
        for material in published_materials:
            material.status = "unpublished"
            material.publish_time = None
            material.publish_status = None
            material.error_message = None
        
        db.commit()
        
        logger.info(f"Batch returned {count} materials to unpublished")
        return {"success": True, "message": f"å·²å°† {count} ä¸ªç´ æè¿”å›åˆ°æœªå‘å¸ƒçŠ¶æ€"}
    except Exception as e:
        logger.error(f"Error in batch return: {str(e)}")
        raise HTTPException(status_code=500, detail=str(e))

@router.post("/batch-clear")
async def batch_clear_published(db: Session = Depends(get_db)):
    """æ‰¹é‡æ¸…ç©ºå·²å‘å¸ƒç´ æ"""
    try:
        # åˆ é™¤æ‰€æœ‰å·²å‘å¸ƒçš„ç´ æ
        published_materials = db.query(XiaohongshuMaterial).filter(
            XiaohongshuMaterial.status == "published"
        ).all()
        
        count = len(published_materials)
        for material in published_materials:
            db.delete(material)
        
        db.commit()
        
        logger.info(f"Batch cleared {count} published materials")
        return {"success": True, "message": f"å·²æ¸…ç©º {count} ä¸ªå·²å‘å¸ƒç´ æ", "cleared_count": count}
    except Exception as e:
        logger.error(f"Error in batch clear: {str(e)}")
        raise HTTPException(status_code=500, detail=str(e))

@router.post("/batch-cancel-scheduled")
async def batch_cancel_scheduled(db: Session = Depends(get_db)):
    """æ‰¹é‡å–æ¶ˆé¢„çº¦å‘å¸ƒ"""
    try:
        # è·å–æ‰€æœ‰é¢„çº¦å‘å¸ƒçš„ç´ æ
        scheduled_materials = db.query(XiaohongshuMaterial).filter(
            XiaohongshuMaterial.status == "unpublished",
            XiaohongshuMaterial.schedule_time != None
        ).all()
        
        count = len(scheduled_materials)
        for material in scheduled_materials:
            material.schedule_time = None
        
        db.commit()
        
        logger.info(f"Batch cancelled {count} scheduled materials")
        return {"success": True, "message": f"å·²å–æ¶ˆ {count} ä¸ªé¢„çº¦å‘å¸ƒä»»åŠ¡"}
    except Exception as e:
        logger.error(f"Error in batch cancel scheduled: {str(e)}")
        raise HTTPException(status_code=500, detail=str(e))

@router.delete("/{material_id}")
async def delete_material(material_id: int, db: Session = Depends(get_db)):
    """åˆ é™¤ç´ æ"""
    try:
        material = db.query(XiaohongshuMaterial).filter(XiaohongshuMaterial.id == material_id).first()
        if not material:
            raise HTTPException(status_code=404, detail="ç´ ææœªæ‰¾åˆ°")
        
        db.delete(material)
        db.commit()
        
        logger.info(f"Deleted material {material_id}")
        return {"success": True, "message": "ç´ æå·²åˆ é™¤"}
    except HTTPException:
        raise
    except Exception as e:
        logger.error(f"Error deleting material: {str(e)}")
        raise HTTPException(status_code=500, detail=str(e))